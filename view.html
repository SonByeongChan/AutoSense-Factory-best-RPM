{% extends 'admin_base.html' %}
{% block title %}AI ëª¨ë¸ ê´€ë¦¬{% endblock %}
{% block content %}

<script>
  // ì¬í•™ìŠµ ì‹¤í–‰ ì‹œ â†’ í˜„ì¬ ë¼ë””ì˜¤ ë²„íŠ¼ ê°’ì„ hiddenìœ¼ë¡œ ë„˜ê²¨ì¤Œ
  function copyCycleToManualForm(form) {
    const selectedCycle = document.querySelector('input[name="update_cycle"]:checked');
    if (selectedCycle) {
      document.getElementById('manual_update_cycle').value = selectedCycle.value;
    }
  }
</script>

<style>
.model-wrapper {
  display: flex;
  gap: 20px;
  margin: 40px auto;
  max-width: none;
  padding: 0 20px;
  box-sizing: border-box;
}

.card-panel {
  flex: 1;
  background-color: #1e1e1e;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}

.card-panel svg {
  display: block;
  margin: 0 auto 20px auto;
}

.card-panel h2, .card-panel p, .card-panel label {
  color: white;
  text-align: center;
}

.button-group-wrapper {
  display: flex;
  justify-content: center;  /* ì¤‘ì•™ ì •ë ¬ */
  margin-top: 30px;
  align-items: center;
  gap: 15px;  
}

.switch-btn {
  padding: 10px ;
  background-color: #7a5fff;
  border: none;
  color: white;
  font-size: 14px;
  cursor: pointer;
  border-radius: 0; /* ê³µí†µ ëª¨ì„œë¦¬ ì´ˆê¸°í™” */
  min-width: 130px;
  transition: background-color 0.2s;
}

.switch-btn:hover {
  background-color: #6b4ee0;
}

/* ì™¼ìª½ ë²„íŠ¼: ì™¼ìª½ë§Œ ë‘¥ê¸€ê²Œ */
.left-btn {
  border-top-left-radius: 6px;
  border-bottom-left-radius: 6px;
}

/* ì˜¤ë¥¸ìª½ ë²„íŠ¼: ì˜¤ë¥¸ìª½ë§Œ ë‘¥ê¸€ê²Œ */
.right-btn {
  border-top-right-radius: 6px;
  border-bottom-right-radius: 6px;
  margin-left: -1px; /* í…Œë‘ë¦¬ ê²¹ì¹˜ê¸° */
}

.model-table {
  width: auto;
  border-collapse: collapse;
  color: white;
  margin-top: 10px;
}

.model-table th, .model-table td {
  vertical-align: middle;
  padding: 10px;
  border-bottom: 1px solid #444;
  text-align: center;
}

.model-table th {
  background-color: #222;
  position: sticky;
  top: 0;
  z-index: 1;
}

.apply-btn, .cancel-btn, .delete-btn {
  padding: 10px 20px;
  font-weight: bold;
  border-radius: 6px;
  border: none;
  margin: 10px;
  cursor: pointer;
}

.delete-btn {
  background-color: #e53935;
  color: white;
}

.apply-btn {
  background-color: #7effa7;
  color: white;
}

.cancel-btn {
  background-color: #ccc;
  color: black;
}

.model-table td button.delete-btn {
  margin: 4px;
  padding: 8px 16px;
  font-size: 14px;
}
#graph-panel {
  display: block;
}

#table-panel {
  display: none;
}

.model-wrapper {
  display: flex;
  flex-wrap: nowrap;
  gap: 50px;
  margin: 20px auto;
  max-width: 1800px;
  padding: 0 20px;
  box-sizing: border-box;
}

.card-panel {
  flex: 1;
  min-width: 0;
  background-color: #1e1e1e;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(0,0,0,0.3);
  display: flex;
  flex-direction: column;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}


</style>

<h2 style="margin: 0; padding: 20px; color: #fff; font-size: 26px;">
  <img src="/static/images/ai_model_img.png"
       alt="AI ëª¨ë¸ ê´€ë¦¬ ì•„ì´ì½˜"
       style="width: 40px; height: 40px; vertical-align: middle; margin-right: 10px;">
  AI ëª¨ë¸ ê´€ë¦¬
</h2>

<div class="model-wrapper">
  <!-- ì™¼ìª½ ì¹´ë“œ: ì„±ëŠ¥ ë° ì„¤ëª… -->
  <div class="card-panel">
    {% set accuracy = (100 - (current_model.mae | float) * 100 ) %}
    {% set percentage = accuracy | round(2) %}
    {% set dashoffset = (100 - percentage) * 3.39292 %}
    <svg width="140" height="140" viewBox="0 0 120 120">
      <circle cx="60" cy="60" r="54" stroke="#00e0ff" stroke-width="12" fill="none" stroke-dasharray="339.292" stroke-dashoffset="0" />
      <circle cx="60" cy="60" r="54" stroke="#2929ff" stroke-width="12" fill="none" stroke-dasharray="339.292" stroke-dashoffset="{{ dashoffset }}" transform="rotate(-90 60 60)" />
      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="22" fill="white" font-family="'Orbitron', sans-serif">
        {{ percentage }}%
      </text>
    </svg>
</svg>
<h2>í˜„ì¬ ëª¨ë¸ ì„±ëŠ¥</h2>
<p>ìµœê·¼ ì—…ë°ì´íŠ¸: {{ current_model.date }}</p>

<!-- âœ… ìë™ ì—…ë°ì´íŠ¸ ì£¼ê¸° ì„¤ì • (ì„ íƒë§Œ í•˜ê³  ì¬í•™ìŠµ ì‹œ ì „ì†¡) -->
    <form id="updateCycleForm" style="display:inline-block; margin-top: 10px; text-align: center;">
      <div style="display: flex; justify-content: center; gap: 16px; align-items: center;">
        <span style="color: white;">ìë™ ì—…ë°ì´íŠ¸ ì£¼ê¸°:</span>
        <label style="color: white;">
          <input type="radio" name="update_cycle" value="1ê°œì›”"
            {% if current_cycle == "1ê°œì›”" %}checked{% endif %}> 1ê°œì›”
        </label>
        <label style="color: white;">
          <input type="radio" name="update_cycle" value="3ê°œì›”"
            {% if current_cycle == "3ê°œì›”" %}checked{% endif %}> 3ê°œì›”
        </label>
        <label style="color: white;">
          <input type="radio" name="update_cycle" value="6ê°œì›”"
            {% if current_cycle == "6ê°œì›”" %}checked{% endif %}> 6ê°œì›”
        </label>
      </div>
    </form>

    <div class="button-group-wrapper">
     <form id="retrainForm" onsubmit="startRetraining(event)">
       <input type="hidden" name="action" value="manual_retrain">
       <input type="hidden" name="update_cycle" id="manual_update_cycle" value="{{ current_cycle }}">
       <button type="submit" class="switch-btn"> ì¬í•™ìŠµ ì‹¤í–‰</button>
    </form>

    <button class="switch-btn" onclick="toggleModelTable()">ëª¨ë¸ êµì²´</button>
    </div> 

    <div id="loadingModal" style="display: none; position: fixed; top: 0; left: 0;
  width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);
  z-index: 9999; justify-content: center; align-items: center;">
  <div style="background-color: white; padding: 24px; border-radius: 12px;
       max-width: 360px; text-align: center;">
    <p style="font-weight: bold; font-size: 18px; color: black;">ğŸ”„ ì¬í•™ìŠµ ì§„í–‰ ì¤‘</p>
    <p style="color: gray;">AI ëª¨ë¸ì´ ì¬í•™ìŠµ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p>
    <div class="spinner" style="margin-top: 16px;">
      <div style="border: 6px solid #eee; border-top: 6px solid #7a5fff; border-radius: 50%;
           width: 40px; height: 40px; animation: spin 1s linear infinite; margin: auto;"></div>
    </div>
  </div>
</div>
    
    <hr style="margin: 20px 0; border-color: #444">
    <p style="color:#ccc">ëª¨ë¸ ì„±ëŠ¥ì€ ê¸°ì¤€ ì¤‘ëŸ‰ê³¼ì˜ ì˜¤ì°¨(MAE)ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
    <p style="color:#ccc">í˜„ì¬ ëª¨ë¸ëª…: <strong>{{ current_model.name }}</strong></p>
  </div>

  <!-- ì˜¤ë¥¸ìª½ ì¹´ë“œ -->
  <div class="card-panel">
    <!-- ê·¸ë˜í”„ íŒ¨ë„ (ê¸°ë³¸ í‘œì‹œ) -->
    <div id="graph-panel">
      <h2 style="text-align: center; color: white;">ì‹¤ì‹œê°„ ì˜ˆì¸¡ ê°’ ë³€í™”</h2>
      <div style="width: 100%; height: 260px;"><canvas id="weightGraph" style="width: 100%; height: 100%;"></canvas></div>
    
    <div style="margin-top: 40px;">
      <h2 style="text-align: center; color: white;">ì‹¤ì‹œê°„ ëˆ„ì  ì˜¤ì°¨ (ACE)</h2>
      <div style="width: 100%; height: 260px;"><canvas id="errorGraph" style="width: 100%; height: 100%;"></canvas></div>
    </div>

    <!-- ìˆ«ì í‘œí˜„-->
    <p id="errorNoModel" style="text-align: center; color: white; font-size: 1.1em; margin-top: 8px;">ëª¨ë¸ ë¯¸ì‚¬ìš© ì‹œ ëˆ„ì  ì˜¤ì°¨: --</p>
    <p id="errorWithModel" style="text-align: center; color: white; font-size: 1.1em; margin-top: 8px;">ëª¨ë¸ ì‚¬ìš© ì‹œ ëˆ„ì  ì˜¤ì°¨: --</p>
  </div>
 
  <!-- í…Œì´ë¸” íŒ¨ë„ (ì´ˆê¸° ìˆ¨ê¹€) -->
  <form method="post" id="modelActionForm">
  <div id="table-panel" style="max-height: 400px; overflow-y: auto;">
    
        <table class="model-table">
          <thead>
            <tr>
              <th></th>
              <th>ë‚ ì§œ</th>
              <th>MAE</th>
              <th>ì†ì‹¤</th>
              <th onclick="sortByLossRate()" style="cursor: pointer;">ì†ì‹¤ë¥  â¬</th>
              <th>ëª¨ë¸ëª…</th>
              <th>ì‚­ì œ</th>
            </tr>
          </thead>
          <tbody>
            {% for model in model_list %}
            <tr>
              <td><input type="radio" name="selected_model" value="{{ model.name }}" {% if model.name == current_model.name %}checked{% endif %}></td>
              <td>{{ model.date }}</td>
              <td>{{ model.mae }}</td>
              <td>{{ model.loss }}</td>
              <td>{{ model.loss_rate }}</td>
              <td>{{ model.name }}</td>
              <td style= "white-space: nowrap; text-align: center;"><button type="button" class="delete-btn" onclick="openDeleteModal()">ì‚­ì œ</button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
  </div>
  <div id="table-buttons" style="text-align: center; padding-top: 12px; background-color: #1e1e1e; display: none;">
  <button type="button" class="apply-btn" onclick="openApplyModal()">ì ìš©</button>
  <button type="button" onclick="toggleModelTable()" class="cancel-btn">ì·¨ì†Œ</button>
</div>
</form>

<!-- âœ… ëª¨ë¸ ì ìš© í™•ì¸ ëª¨ë‹¬ -->
<div id="applyModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
  <div style="background-color: white; padding: 24px; border-radius: 12px; max-width: 360px; text-align: center;">
    <p style="font-weight: bold; color: green; font-size: 18px;">âš ï¸ ëª¨ë¸ ì ìš© í™•ì¸</p>
    <p>ì„ íƒí•œ ëª¨ë¸ì„ ì‹¤ì œ ê³µì •ì— ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    <p style="font-size: 13px; color: gray;">ì´ ì‘ì—…ì€ í˜„ì¬ ìš´ì˜ ì¤‘ì¸ ëª¨ë¸ì„ ëŒ€ì²´í•©ë‹ˆë‹¤.</p>
    <div style="margin-top: 16px; display: flex; justify-content: center; gap: 16px;">
      <button class="apply-btn" onclick="confirmApply()">ì ìš©</button>
      <button class="cancel-btn" onclick="closeApplyModal()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- âœ… ëª¨ë¸ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="deleteModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
  <div style="background-color: white; padding: 24px; border-radius: 12px; max-width: 360px; text-align: center;">
    <p style="font-weight: bold; color: red; font-size: 18px;">âš ï¸ ëª¨ë¸ ì‚­ì œ í™•ì¸</p>
    <p>ì„ íƒí•œ ëª¨ë¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    <p style="font-size: 13px; color: gray;">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    <div style="margin-top: 16px; display: flex; justify-content: center; gap: 16px;">
      <button class="delete-btn" onclick="confirmDelete()">ì‚­ì œ</button>
      <button class="cancel-btn" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>
    </div>
  </div>
</div>


<!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ëª¨ë“  ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
  // 1. í…Œì´ë¸” ë‚´ ì†ì‹¤ë¥  ì—´ì„ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬í•˜ëŠ” í•¨ìˆ˜
  function sortByLossRate() {
    const table = document.querySelector('.model-table tbody');
    const rows = Array.from(table.rows);
    rows.sort((a, b) => {
      const aVal = parseFloat(a.cells[4].textContent.trim());
      const bVal = parseFloat(b.cells[4].textContent.trim());
      return aVal - bVal;
    });
    rows.forEach(row => table.appendChild(row));
  }

  // 2. ëª¨ë¸ ì ìš© ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°, ì ìš© í™•ì •
  function openApplyModal() { document.getElementById('applyModal').style.display = 'flex'; }
  function closeApplyModal() { document.getElementById('applyModal').style.display = 'none'; }
  function confirmApply() {
    closeApplyModal();
    const form = document.getElementById('modelActionForm');
    if (!form) {
      console.error('âŒ modelActionForm í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // â‘¡ ì„ íƒëœ ëª¨ë¸ ë¼ë””ì˜¤ ë²„íŠ¼ ê°’ì„ ì½ì–´ì˜µë‹ˆë‹¤.
    const selected = form.querySelector('input[name="selected_model"]:checked');
    if (!selected) {
      alert('êµì²´í•  ëª¨ë¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    // â‘¢ hidden input ì„ ì¶”ê°€: action=apply
    const actionInput = document.createElement('input');
    actionInput.type  = 'hidden';
    actionInput.name  = 'action';
    actionInput.value = 'apply';
    form.appendChild(actionInput);

    // â‘£ hidden input ì„ ì¶”ê°€: selected_model=<ì„ íƒëœ ê°’>
    const modelInput = document.createElement('input');
    modelInput.type  = 'hidden';
    modelInput.name  = 'selected_model';
    modelInput.value = selected.value;
    form.appendChild(modelInput);

    // â‘¤ í¼ ì „ì†¡
    form.submit();
  }


  // 3. ëª¨ë¸ ì‚­ì œ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°, ì‚­ì œ í™•ì •
  function openDeleteModal() { document.getElementById('deleteModal').style.display = 'flex'; }
  function closeDeleteModal() { document.getElementById('deleteModal').style.display = 'none'; }
  function confirmDelete() {
    closeDeleteModal();
    const form = document.getElementById('modelActionForm');
    const selected = form.querySelector('input[name="selected_model"]:checked');
    if (selected) {
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = 'action';
      hiddenInput.value = `delete:${selected.value}`;
      form.appendChild(hiddenInput);
      form.submit();
    } else {
      alert('ì‚­ì œí•  ëª¨ë¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    }
  }

  // 4. ê·¸ë˜í”„/í…Œì´ë¸” í™”ë©´ ì „í™˜ í•¨ìˆ˜
  function toggleModelTable() {
    const graph = document.getElementById('graph-panel');
    const table = document.getElementById('table-panel');
    const buttons = document.getElementById('table-buttons');
    if (graph && table && buttons) {
      const isGraphVisible = graph.style.display !== 'none';
      graph.style.display   = isGraphVisible ? 'none' : 'block';
      table.style.display   = isGraphVisible ? 'block' : 'none';
      buttons.style.display = isGraphVisible ? 'block' : 'none';
    }
  }

  // 5. Chart.js ê¸°ë°˜ ì‹¤ì‹œê°„ ì¤‘ëŸ‰ + ëˆ„ì  ì˜¤ì°¨ ì°¨íŠ¸ ë¡œì§
  let liveChart, errorChart;
  let noModelEl, withModelEl;
  let fullData = null;
  let currentIndex = 0;
  let changeLineIndexes = [];
  let cumRealErr = [];
  let cumPredErr = [];

  // ì „ì²´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° ì°¨íŠ¸ ì´ˆê¸°í™”
  function loadFullData() {
    fetch('/api/production')
      .then(res => res.json())
      .then(data => {
        if (!data || data.error || !data.real_weight?.length) return;
        fullData = data;
        changeLineIndexes = [...(data.change_points || [])];
        cumRealErr = data.cum_real_err || [];
        cumPredErr = data.cum_pred_err || [];

        createLiveChart();
        playbackOneByOne();
        setInterval(playbackOneByOne, 1000);
        setInterval(updateErrorDisplay, 1000);
      });
  }

// ëˆ„ì  ì˜¤ì°¨ ê°’ì„ í™”ë©´ì— í‘œì‹œ
  function updateErrorDisplay(realErr, predErr) {
  const noEl   = document.getElementById('errorNoModel');
  const withEl = document.getElementById('errorWithModel');
  if (noEl)   noEl.textContent   = `ëª¨ë¸ ë¯¸ì‚¬ìš© ì‹œ ëˆ„ì  ì˜¤ì°¨: ${realErr}`;
  if (withEl) withEl.textContent = `ëª¨ë¸ ì‚¬ìš© ì‹œ ëˆ„ì  ì˜¤ì°¨: ${predErr}`;
}

  // í•œ í¬ì¸íŠ¸ì”© ì°¨íŠ¸ì— ì¶”ê°€ (ìŠ¤íŠ¸ë¦¬ë°)
  function playbackOneByOne() {
    if (!fullData || currentIndex >= fullData.real_weight.length) return;

    const label = currentIndex;
    const real  = fullData.real_weight[currentIndex];
    const pred  = fullData.predicted_reco[currentIndex];
    updateChart(label, real, pred);

    const realErr = cumRealErr[currentIndex] ?? 0;
    const predErr = cumPredErr[currentIndex] ?? 0;
    
    if (errorChart.data.datasets[0].data.length >= 10000) {
      errorChart.data.datasets[0].data.shift();
      errorChart.data.datasets[1].data.shift();
    }
    errorChart.data.labels.push(label);
    errorChart.data.datasets[0].data.push(realErr);
    errorChart.data.datasets[1].data.push(predErr);
    errorChart.update();

    updateErrorDisplay(realErr, predErr);
    currentIndex++;
  }

  // ì°¨íŠ¸ ìƒì„± ë° í˜„ì¬ ëˆ„ì  ì˜¤ì°¨ í‘œì‹œ ìš”ì†Œ ìºì‹±
  function createLiveChart() {
    noModelEl   = document.getElementById('errorNoModel');
    withModelEl = document.getElementById('errorWithModel');

    // â”€â”€ ì‹¤ì‹œê°„ ì¤‘ëŸ‰ ì°¨íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const canvas = document.getElementById('weightGraph');
    if (!canvas || typeof canvas.getContext !== 'function') {
      console.error('âŒ weightGraph canvas not found or invalid.');
      return;
    }
    const ctx = canvas.getContext('2d');
    liveChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'ì‹¤ì¸¡ ì¤‘ëŸ‰',
            data: [],
            borderColor: '#00ffff',
            pointBackgroundColor: [],
            fill: false,
            tension: 0.3
          },
          {
            label: 'ì˜ˆì¸¡ ì¤‘ëŸ‰ (ì¶”ì²œ k_rpm)',
            data: [],
            borderColor: '#ffaa00',
            pointBackgroundColor: [],
            fill: false,
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        animation: false,
        plugins: {
          legend: { labels: { color: '#ccc' } }
        },
        scales: {
          x: {
            title: { display: true, text: 'Index' },
            ticks: { color: '#ccc' },
            grid: { color: '#444' }
          },
          y: {
            title: { display: true, text: 'ì¤‘ëŸ‰ (g)' },
            min: 2.9,
            max: 3.3,
            ticks: { color: '#ccc' },
            grid: { color: '#444' }
          }
        }
      },
      plugins: [{
        id: 'rpm_change_lines',
        afterDraw(chart) {
          const { ctx, chartArea: { top, bottom }, scales: { x } } = chart;
          ctx.save();
          ctx.strokeStyle = 'red';
          ctx.setLineDash([4, 4]);
          ctx.lineWidth = 1.5;
          const visibleLabels = chart.data.labels;
          changeLineIndexes.forEach(globalIndex => {
            const localIndex = visibleLabels.indexOf(globalIndex);
            if (localIndex === -1) return;
            const xCoord = x.getPixelForValue(localIndex);
            if (isNaN(xCoord)) return;
            ctx.beginPath();
            ctx.moveTo(xCoord, top);
            ctx.lineTo(xCoord, bottom);
            ctx.stroke();
          });
          ctx.restore();
        }
      }]
    });

    // â”€â”€ ëˆ„ì  ì˜¤ì°¨ ì°¨íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const errCanvas = document.getElementById('errorGraph');
    if (!errCanvas || typeof errCanvas.getContext !== 'function') {
      console.error('âŒ errorGraph canvas not found or invalid.');
      return;
    }
    const errCtx = errCanvas.getContext('2d');
    errorChart = new Chart(errCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'ì‹¤ì œ ëˆ„ì  ì˜¤ì°¨',
            data: [],
            borderColor: '#ff4444',
            fill: false,
            tension: 0.3
          },
          {
            label: 'ì˜ˆì¸¡ ëˆ„ì  ì˜¤ì°¨',
            data: [],
            borderColor: '#44ff44',
            fill: false,
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        animation: false,
        plugins: {
          legend: { labels: { color: '#ccc' } }
        },
        scales: {
          x: {
            title: { display: true, text: 'Index' },
            ticks: { color: '#ccc' },
            grid: { color: '#444' }
          },
          y: {
            title: { display: true, text: 'ì ˆëŒ€ ëˆ„ì  ì˜¤ì°¨' },
            ticks: { color: '#ccc' },
            grid: { color: '#444' }
          }
        }
      }
    });
  }


  // ì‹¤ì‹œê°„ ì¤‘ëŸ‰ ì—…ë°ì´íŠ¸
  function updateChart(label, real, pred) {
    if (!liveChart) return;
    const maxPoints = 10;
    if (liveChart.data.labels.length >= maxPoints) {
      liveChart.data.labels.shift();
      liveChart.data.datasets[0].data.shift();
      liveChart.data.datasets[1].data.shift();
    }
    liveChart.data.labels.push(label);
    liveChart.data.datasets[0].data.push(real);
    liveChart.data.datasets[1].data.push(pred);
    liveChart.update();
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
  window.addEventListener('DOMContentLoaded', loadFullData);
</script>


<script>
  // ëˆ„ë½ëœ helper í•¨ìˆ˜ ì •ì˜
  function copyCycleToManualForm() {
    const auto = document.getElementById('autoCycleInput');
    const manual = document.getElementById('manualCycleInput');
    if (auto && manual) manual.value = auto.value;
  }

  function startRetraining(event) {
    event.preventDefault();
    copyCycleToManualForm();

    document.getElementById('loadingModal').style.display = 'flex';
    const form = document.getElementById('retrainForm');
    const formData = new FormData(form);

    fetch('/admin/aimodel', {
      method: 'POST',
      body: formData
    })
    .then(res => {
      if (!res.ok) throw new Error('ì¬í•™ìŠµ ì‹¤íŒ¨');
      return res.text();
    })
    .then(result => {
      console.log('ì¬í•™ìŠµ ì™„ë£Œ:', result);
      location.reload();
    })
    .catch(err => {
      document.getElementById('loadingModal').style.display = 'none';
      alert('ì¬í•™ìŠµ ì¤‘ ì˜¤ë¥˜ ë°œìƒ!');
      console.error(err);
    });
  }

  // í¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
  window.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('retrainForm');
    if (form) form.addEventListener('submit', startRetraining);
  });
</script>
{% endblock %}
