{% extends 'admin_base.html' %}
{% block title %}AI ëª¨ë¸ ê´€ë¦¬{% endblock %}
{% block content %}

<script>
  // ì¬í•™ìŠµ ì‹¤í–‰ ì‹œ â†’ í˜„ì¬ ë¼ë””ì˜¤ ë²„íŠ¼ ê°’ì„ hiddenìœ¼ë¡œ ë„˜ê²¨ì¤Œ
  function copyCycleToManualForm(form) {
    const selectedCycle = document.querySelector('input[name="update_cycle"]:checked');
    if (selectedCycle) {
      document.getElementById('manual_update_cycle').value = selectedCycle.value;
    }
  }
</script>

<style>
.model-wrapper {
  display: flex;
  gap: 20px;
  margin: 40px auto;
  max-width: none;
  padding: 0 20px;
  box-sizing: border-box;
}

.card-panel {
  flex: 1;
  background-color: #000000dc;
  padding: 30px;
  border-radius: 12px;
  border: 1px solid #333333;
  box-shadow: 0 0 7px #00bfff;            /* glow íš¨ê³¼ */
}

.card-panel svg {
  display: block;
  margin: 0 auto 20px auto;
}
.card-panel h2{
  color: #ffffff;
  font-size: 22px;
  /* border-bottom: 1px solid #00bfff; ì œëª© í•˜ë‹¨ êµ¬ë¶„ì„  */
  padding-bottom: 10px;
  margin-bottom: 16px;
  font-family: 'Orbitron', sans-serif; /*  ì œëª© ê°•ì¡° */
  margin-top: 0;
}
.card-panel p, .card-panel label {
  color: #ccc;
  text-align: center;
  font-size: 15px;
}
/* ===========ì™¼ìª½ ì°¨íŠ¸ ì¹´ë“œ============= */

.card-panel1 {
  /* height: 100%;
  max-height: 650px; */

  flex: 1;
  min-width: 0;
  background-color: #000000dc;
  padding: 20px;
  border-radius: 12px;
  border: 1px solid #333333;
  box-shadow: 0 0 7px #00bfff;            /* glow íš¨ê³¼ */
  display: flex;
  flex-direction: column;

  align-self: flex-start !important;
}


.card-panel1 svg {
  display: block;
  margin: 0 auto 20px auto;
}
.card-panel1 h2{
  color: #ffffff;
  font-size: 22px;
  /* border-bottom: 1px solid #00bfff;  ì œëª© í•˜ë‹¨ êµ¬ë¶„ì„  */
  padding-bottom: 10px;
  margin-bottom: 16px;
  font-family: 'Orbitron', sans-serif; /*  ì œëª© ê°•ì¡° */
  margin-top: 0;
}
.card-panel1 p, .card-panel1 label {
  color: #dddddd;
  text-align: center;
  font-size: 15px;
}

/* ======================== */

.button-group-wrapper {
  display: flex;
  justify-content: center;  /* ì¤‘ì•™ ì •ë ¬ */
  margin-top: 30px;
  align-items: center;
  gap: 15px;  
}

.switch-btn {
  padding: 10px 16px;
  background-color: #7a5fff;
  border: none;
  color: white;
  font-size: 14px;
  font-weight: 600;
  border-radius: 6px;
  min-width: 140px;
  transition: background-color 0.2s, box-shadow 0.2s;
}

.switch-btn:hover {
  background-color: #6b4ee0;
  box-shadow: 0 0 10px #7a5fff; /*  hover glow */
}

/* ì™¼ìª½ ë²„íŠ¼: ì™¼ìª½ë§Œ ë‘¥ê¸€ê²Œ */
.left-btn {
  border-top-left-radius: 6px;
  border-bottom-left-radius: 6px;
}

/* ì˜¤ë¥¸ìª½ ë²„íŠ¼: ì˜¤ë¥¸ìª½ë§Œ ë‘¥ê¸€ê²Œ */
.right-btn {
  border-top-right-radius: 6px;
  border-bottom-right-radius: 6px;
  margin-left: -1px; /* í…Œë‘ë¦¬ ê²¹ì¹˜ê¸° */
}

.model-table {
  width: auto;
  border-collapse: collapse;
  color: white;
  margin-top: 14px;
}

.model-table th, .model-table td {
  padding: 10px 12px;
  border-bottom: 1px solid #444;
  text-align: center;
}

.model-table tbody tr:hover {
  background-color: #1e1e1e;
}

.model-table th {
  background-color: #222;
  position: sticky;
  top: 0;
  z-index: 1;
}

.apply-btn, .cancel-btn, .delete-btn {
  padding: 10px 20px;
  font-weight: bold;
  border-radius: 6px;
  border: none;
  /* margin: 10px; */
  cursor: pointer;
}

.delete-btn {
  background-color: #e53935;
  color: white;
}

.apply-btn {
  background-color: #7effa7;
  color: white;
}

.cancel-btn {
  background-color: #ccc;
  color: black;
}

.model-table td button.delete-btn {
  margin: 4px;
  padding: 8px 16px;
  font-size: 14px;
}
#graph-panel {
  display: block;
}

#table-panel {
  display: none;
}

.model-wrapper {
  display: flex;
  align-items: stretch;  /*  ì–‘ìª½ ì¹´ë“œ ë†’ì´ ë§ì¶”ê¸° */
  gap: 50px;
  max-width: 1800px;
  padding: 0 20px;
  margin: 20px auto;
  box-sizing: border-box;
}

.card-panel {
  flex: 2;
  min-width: 0;
  background-color: #000000dc;
  padding: 20px;
  border-radius: 12px;
  border: 1px solid #333333;
  box-shadow: 0 0 7px #00bfff;            /* glow íš¨ê³¼ */
  display: flex;
  flex-direction: column;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* âœ… ë„ë„› ì°¨íŠ¸ í…ìŠ¤íŠ¸ ê°œì„  */
text {
  font-size: 26px;
  font-weight: bold;
  /* fill: #00f0ff; */
  font-family: 'Orbitron', sans-serif;
}

.error-comparison {
  width: 100%;
  border: 1px solid #444;
  border-collapse: collapse;
  margin-top: 16px;
  font-size: 16px;
  color: white;
}
.error-comparison th, .error-comparison td {
  border: 1px solid #444;
  padding: 12px;
  text-align: center;
}

.error-comparison th {
  background-color: #1a1a1a;
  font-weight: bold;
  color: #ffffff;
}

.error-comparison td {
  background-color: #111;
}

input[type="radio"] {
  accent-color: #0004ff; /*  ì›í•˜ëŠ” ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
}



</style>

<h2 style="margin: 0; padding: 20px; color: #fff; font-size: 26px;">
  <img src="/static/images/ai_model_img.png"
       alt="AI ëª¨ë¸ ê´€ë¦¬ ì•„ì´ì½˜"
       style="width: 40px; height: 40px; vertical-align: middle; margin-right: 10px;">
  AI ëª¨ë¸ ê´€ë¦¬
</h2>

<div class="model-wrapper">
  <!-- ì™¼ìª½ ì¹´ë“œ: ì„±ëŠ¥ ë° ì„¤ëª… -->
  <div class="card-panel1">
    {% set accuracy = (100 - (current_model.mae | float) * 100 ) %}
    {% set percentage = accuracy | round(2) %}
    {% set dashoffset = (100 - percentage) * 3.39292 %}

    <h2>í˜„ì¬ ëª¨ë¸ ì„±ëŠ¥</h2>
    <svg width="200" height="200" viewBox="0 0 120 120">
      <circle cx="60" cy="60" r="54" stroke="#00e0ff" stroke-width="12" fill="none" stroke-dasharray="339.292" stroke-dashoffset="0" />
      <circle cx="60" cy="60" r="54" stroke="#2929ff" stroke-width="12" fill="none" stroke-dasharray="339.292" stroke-dashoffset="{{ dashoffset }}" transform="rotate(-90 60 60)" />
      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="22" fill="white" font-family="'Orbitron', sans-serif">
        {{ percentage }}%
      </text>
      
    </svg>
<!-- </svg> -->
<!-- <h2>í˜„ì¬ ëª¨ë¸ ì„±ëŠ¥</h2> -->
<p style="font-size: 22px; font-weight: bold;">ìµœê·¼ ì—…ë°ì´íŠ¸: {{ current_model.date }}</p>

<!--  ìë™ ì—…ë°ì´íŠ¸ ì£¼ê¸° ì„¤ì • (ì„ íƒë§Œ í•˜ê³  ì¬í•™ìŠµ ì‹œ ì „ì†¡) -->
    <form id="updateCycleForm" style="display:inline-block; margin-top: 10px; text-align: center;">
      <div style="display: flex; justify-content: center; gap: 16px; align-items: center;">
        <span style="font-size: 18; font-weight: bold; color: white;">ìë™ ì—…ë°ì´íŠ¸ ì£¼ê¸°:</span>
        <label style="color: white;">
          <input type="radio" name="update_cycle" value="1ê°œì›”"
            {% if current_cycle == "1ê°œì›”" %}checked{% endif %}> 1ê°œì›”
        </label>
        <label style="color: white;">
          <input type="radio" name="update_cycle" value="3ê°œì›”"
            {% if current_cycle == "3ê°œì›”" %}checked{% endif %}> 3ê°œì›”
        </label>
        <label style="color: white;">
          <input type="radio" name="update_cycle" value="6ê°œì›”"
            {% if current_cycle == "6ê°œì›”" %}checked{% endif %}> 6ê°œì›”
        </label>
      </div>
    </form>

    <div class="button-group-wrapper">
     <form id="retrainForm" onsubmit="startRetraining(event)">
       <input type="hidden" name="action" value="manual_retrain">
       <input type="hidden" name="update_cycle" id="manual_update_cycle" value="{{ current_cycle }}">
       <button type="submit" class="switch-btn"> ì¬í•™ìŠµ ì‹¤í–‰</button>
    </form>

    <button class="switch-btn" onclick="toggleModelTable()">ëª¨ë¸ êµì²´</button>
    </div> 

    <div id="loadingModal" style="display: none; position: fixed; top: 0; left: 0;
  width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);
  z-index: 9999; justify-content: center; align-items: center;">
  <div style="background-color: white; padding: 24px; border-radius: 12px;
       max-width: 360px; text-align: center;">
    <p style="font-weight: bold; font-size: 18px; color: black;">ğŸ”„ ì¬í•™ìŠµ ì§„í–‰ ì¤‘</p>
    <p style="color: gray;">AI ëª¨ë¸ì´ ì¬í•™ìŠµ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p>
    <div class="spinner" style="margin-top: 16px;">
      <div style="border: 6px solid #eee; border-top: 6px solid #7a5fff; border-radius: 50%;
           width: 40px; height: 40px; animation: spin 1s linear infinite; margin: auto;"></div>
    </div>
  </div>
</div>
    
    <hr style="margin: 20px 0; border-color: #444">
    <p style="color:#ccc">â€» ëª¨ë¸ ì„±ëŠ¥ì€ ê¸°ì¤€ ì¤‘ëŸ‰ê³¼ì˜ ì˜¤ì°¨(MAE)ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
    <p style="font-size: 18; font-weight: bold; color:#ccc">í˜„ì¬ ëª¨ë¸ëª…: <strong>{{ current_model.name }}</strong></p>

    
        <table class="error-comparison" style="width: 100%; margin-top: 16px; color: white; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="border-bottom: 1px solid #444; padding: 8px; text-align: center;">
            ëª¨ë¸ ë¯¸ì‚¬ìš© ì‹œ ì†ì‹¤ë¹„ìš©
          </th>
          <th style="border-bottom: 1px solid #444; padding: 8px; text-align: center;">
            ëª¨ë¸ ì‚¬ìš© ì‹œ ì†ì‹¤ë¹„ìš©
          </th>
          <th style="border-bottom: 1px solid #444; padding: 8px; text-align: center;">
            ì ˆê° ë¹„ìš©
          </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td id="errorNoModel" style="padding: 8px; text-align: center;">--</td>
          <td id="errorWithModel" style="padding: 8px; text-align: center;">--</td>
          <td id="errorSaved" style="padding: 8px; text-align: center;">--</td>
        </tr>
      </tbody>
    </table>
  </div>



  <!-- ì˜¤ë¥¸ìª½ ì¹´ë“œ -->
<div class="card-panel">
  <!-- 1) ê·¸ë˜í”„ + ë¹„êµ í…Œì´ë¸” íŒ¨ë„ (ê¸°ë³¸ í‘œì‹œ) -->
  <div id="graph-panel">
    <h2 style="text-align: left; color: white;">ì‹¤ì‹œê°„ ì˜ˆì¸¡ ê°’ ë³€í™”</h2>
    <div style="width: 100%; height: 260px;">
      <canvas id="weightGraph" style="width: 100%; height: 100%;"></canvas>
    </div>

    <!--  ê·¸ë˜í”„ ì‚¬ì´ êµ¬ë¶„ì„  -->
    <hr style="margin: 20px 0 4px 0; border: none; border-top: 1px solid #00bfff;"> 

    <div style="margin-top: 20px;">
      <h2 style="text-align: left; color: white;">ì‹¤ì‹œê°„ ëˆ„ì  ì˜¤ì°¨ (ACE)</h2>
      <div style="width: 100%; height: 260px;">
        <canvas id="errorGraph" style="width: 100%; height: 100%;"></canvas>
      </div>
    </div>

  </div> <!-- /#graph-panel -->

  <!-- 2) ëª¨ë¸ ë¦¬ìŠ¤íŠ¸ íŒ¨ë„ (ì´ˆê¸° ìˆ¨ê¹€) -->
  <form id="modelActionForm" method="post">
    <div id="table-panel"
         style="display: none; max-height: 400px; overflow-y: auto; margin-top: 20px;">
      <table class="model-table" style="width:100%; border-collapse: collapse; color:white;">
        <thead>
          <tr>
            <th></th>
            <th>ë‚ ì§œ</th>
            <th>MAE</th>
            <th>ì†ì‹¤</th>
            <th onclick="sortByLossRate()" style="cursor: pointer;">ì†ì‹¤ë¥  â¬</th>
            <th>ëª¨ë¸ëª…</th>
            <th>ì‚­ì œ</th>
          </tr>
        </thead>
        <tbody>
          {% for model in model_list %}
          <tr>
            <td>
              <input type="radio"
                     name="selected_model"
                     value="{{ model.name }}"
                     {% if model.name == current_model.name %}checked{% endif %}>
            </td>
            <td>{{ model.date }}</td>
            <td>{{ model.mae }}</td>
            <td>{{ model.loss }}</td>
            <td>{{ model.loss_rate }}</td>
            <td>{{ model.name }}</td>
            <td style="white-space:nowrap; text-align:center;">
              <button type="button"
                      class="delete-btn"
                      onclick="openDeleteModal()">ì‚­ì œ</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div> <!-- /#table-panel -->

    <div id="table-buttons"
         style="display: none; text-align: center; padding: 12px 0; background-color: #1e1e1e;">
      <button type="button" class="apply-btn" onclick="openApplyModal()">ì ìš©</button>
      <button type="button" class="cancel-btn" onclick="toggleModelTable()">ì·¨ì†Œ</button>
    </div>
  </form>
</div> <!-- /.card-panel -->

<!--  ëª¨ë¸ ì ìš© í™•ì¸ ëª¨ë‹¬ -->
<div id="applyModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
  <div style="background-color: white; padding: 24px; border-radius: 12px; max-width: 360px; text-align: center;">
    <p style="font-weight: bold; color: green; font-size: 18px;">âš ï¸ ëª¨ë¸ ì ìš© í™•ì¸</p>
    <p>ì„ íƒí•œ ëª¨ë¸ì„ ì‹¤ì œ ê³µì •ì— ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    <p style="font-size: 13px; color: gray;">ì´ ì‘ì—…ì€ í˜„ì¬ ìš´ì˜ ì¤‘ì¸ ëª¨ë¸ì„ ëŒ€ì²´í•©ë‹ˆë‹¤.</p>
    <div style="margin-top: 16px; display: flex; justify-content: center; gap: 16px;">
      <button class="apply-btn" onclick="confirmApply()">ì ìš©</button>
      <button class="cancel-btn" onclick="closeApplyModal()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!--  ëª¨ë¸ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="deleteModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
  <div style="background-color: white; padding: 24px; border-radius: 12px; max-width: 360px; text-align: center;">
    <p style="font-weight: bold; color: red; font-size: 18px;">âš ï¸ ëª¨ë¸ ì‚­ì œ í™•ì¸</p>
    <p>ì„ íƒí•œ ëª¨ë¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    <p style="font-size: 13px; color: gray;">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    <div style="margin-top: 16px; display: flex; justify-content: center; gap: 16px;">
      <button class="delete-btn" onclick="confirmDelete()">ì‚­ì œ</button>
      <button class="cancel-btn" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// í…Œì´ë¸” ë‚´ ì†ì‹¤ë¥  ì—´ì„ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬í•˜ëŠ” í•¨ìˆ˜
function sortByLossRate() {
  const table = document.querySelector('.model-table tbody');  // í…Œì´ë¸” ë°”ë”” ì„ íƒ
  const rows = Array.from(table.rows);   // ëª¨ë“  í–‰ì„ ë°°ì—´ë¡œ ë³€í™˜

  // ê° í–‰ì˜ 5ë²ˆì§¸ ì—´(ì†ì‹¤ë¥ )ì„ ìˆ«ìë¡œ ë³€í™˜ í›„ ì •ë ¬
  rows.sort((a, b) => {
    const aVal = parseFloat(a.cells[4].textContent.trim());
    const bVal = parseFloat(b.cells[4].textContent.trim());
    return aVal - bVal;
  });
 // ì •ë ¬ëœ í–‰ì„ ë‹¤ì‹œ í…Œì´ë¸”ì— ë¶™ì—¬ë„£ê¸°
  rows.forEach(row => table.appendChild(row));
}

// ëª¨ë¸ ì ìš© ëª¨ë‹¬ ì—´ê¸°
function openApplyModal() {
  document.getElementById('applyModal').style.display = 'flex';
}

// ëª¨ë¸ ì ìš© ëª¨ë‹¬ ë‹«ê¸°
function closeApplyModal() {
  document.getElementById('applyModal').style.display = 'none';
}

// ëª¨ë¸ ì ìš©ì„ í™•ì •í•˜ê³  ì„œë²„ì— ì ìš© ìš”ì²­ ì „ì†¡
function confirmApply() {
  closeApplyModal();
  const form = document.querySelector('form');  // í¼ ì„ íƒ
  const hiddenInput = document.createElement('input');   // ìˆ¨ê²¨ì§„ input ìƒì„±
  hiddenInput.type = 'hidden';
  hiddenInput.name = 'action';
  hiddenInput.value = 'apply';  // applyë¡œ ì„¤ì •
  form.appendChild(hiddenInput);  // í¼ì— input ì¶”ê°€
  form.submit();  // í¼ ì „ì†¡
}

// ëª¨ë¸ ì‚­ì œ ëª¨ë‹¬ ì—´ê¸°
function openDeleteModal() {
  document.getElementById('deleteModal').style.display = 'flex';
}

// ëª¨ë¸ ì‚­ì œ ëª¨ë‹¬ ë‹«ê¸°
function closeDeleteModal() {
  document.getElementById('deleteModal').style.display = 'none';
}

// ì„ íƒí•œ ëª¨ë¸ ì‚­ì œë¥¼ í™•ì •í•˜ê³  ì„œë²„ì— ìš”ì²­

function confirmDelete() {
  closeDeleteModal();
  const form = document.getElementById('modelActionForm');
  const selected = form.querySelector('input[name="selected_model"]:checked');
  if (selected) {
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'action';
    hiddenInput.value = `delete:${selected.value}`;
    form.appendChild(hiddenInput);
    form.submit();
  } else {
    alert('ì‚­ì œí•  ëª¨ë¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
  }
}
</script>

<script id="enhanced-graph-script">
// ê·¸ë˜í”„ì™€ í…Œì´ë¸” í™”ë©´ ì „í™˜ í•¨ìˆ˜
function toggleModelTable() {
  const graph = document.getElementById('graph-panel');
  const table = document.getElementById('table-panel');
  const buttons = document.getElementById('table-buttons');

  // í˜„ì¬ ê·¸ë˜í”„ê°€ ë³´ì´ë©´ í…Œì´ë¸”ì„ í‘œì‹œí•˜ê³ , ë°˜ëŒ€ë©´ ê·¸ë˜í”„ë¥¼ í‘œì‹œ
  if (graph && table && buttons) {
    const isGraphVisible = graph.style.display !== 'none';
    graph.style.display = isGraphVisible ? 'none' : 'block';
    table.style.display = isGraphVisible ? 'block' : 'none';
    buttons.style.display = isGraphVisible ? 'block' : 'none';
  }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let liveChart;
let fullData = null;         // ì „ì²´ ë°ì´í„°ë¥¼ ë³´ê´€í•  ì „ì—­ ë³€ìˆ˜
let currentIndex = 0;        // í˜„ì¬ ê·¸ë¦´ ì¸ë±ìŠ¤
let changeLineIndexes = []; // ë¹¨ê°„ ì ì„ ì„ í‘œì‹œí•  change_points
let cumRealErr = [], cumPredErr = [];

//  1. ì „ì²´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
function loadFullData() {
  fetch('/api/production')
    .then(res => res.json())
    .then(data => {
      if (!data || data.error || !data.real_weight?.length) return;

      fullData = data;
      changeLineIndexes = [...(data.change_points || [])]; // ë¹¨ê°„ ì„  ì¸ë±ìŠ¤ ì €ì¥
      cumRealErr = data.cum_real_err || [];
      cumPredErr = data.cum_pred_err || [];

      createLiveChart();              // ì°¨íŠ¸ ìƒì„±
      playbackOneByOne();            // ì²« í¬ì¸íŠ¸ ì¬ìƒ
      setInterval(playbackOneByOne, 1000); // ì´í›„ 1ì´ˆë§ˆë‹¤ í•œ í¬ì¸íŠ¸ì”© ì¬ìƒ
    });
}
  // ìˆ˜ì • g => ì›
  function updateErrorDisplay(realErr, predErr) {
    const unitPrice = 7; // 1gë‹¹ 7ì›
    const realWon = Math.round(realErr * unitPrice);
    const predWon = Math.round(predErr * unitPrice);
    const savedWon = realWon - predWon;

    const noCell   = document.getElementById('errorNoModel');
    const withCell = document.getElementById('errorWithModel');
    const savedCell = document.getElementById('errorSaved');

    if (noCell)   noCell.textContent   = realWon.toLocaleString() + ' ì›';
    if (withCell) withCell.textContent = predWon.toLocaleString() + ' ì›';
    if (savedCell) savedCell.innerHTML = `<span style="color: ${savedWon >= 0 ? '#00ff88' : '#ff4444'}; font-weight: bold;">${savedWon >= 0 ? '+ ' : ''}${savedWon.toLocaleString()} ì› â†‘</span>`;
  }

//  2. ì‹¤ì‹œê°„ìœ¼ë¡œ í•œ í¬ì¸íŠ¸ì”© ì°¨íŠ¸ì— ì¶”ê°€
function playbackOneByOne() {
  if (!fullData || currentIndex >= fullData.real_weight.length) return;

  const label = currentIndex;
  const real = fullData.real_weight[currentIndex];
  const pred = fullData.predicted_reco[currentIndex];
  updateChart(label, real, pred);

  const realErr = cumRealErr[currentIndex] ?? 0;
  const predErr = cumPredErr[currentIndex] ?? 0;
    
  if (errorChart.data.datasets[0].data.length >= 10000) {
    errorChart.data.datasets[0].data.shift();
    errorChart.data.datasets[1].data.shift();
  }
  errorChart.data.labels.push(label);
  errorChart.data.datasets[0].data.push(realErr);
  errorChart.data.datasets[1].data.push(predErr);
  errorChart.update();

  updateErrorDisplay(realErr, predErr);
  currentIndex++;
}

//  3. Chart.js ì°¨íŠ¸ ìƒì„±
function createLiveChart() {

  noModelEl   = document.getElementById('errorNoModel');
  withModelEl = document.getElementById('errorWithModel');

   // â”€â”€ ì‹¤ì‹œê°„ ì¤‘ëŸ‰ ì°¨íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const canvas = document.getElementById('weightGraph');
  if (!canvas || typeof canvas.getContext !== 'function') {
    console.error('âŒ weightGraph canvas not found or invalid.');
    return;
  }

  const ctx = canvas.getContext('2d');

  liveChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: 'ì‹¤ì¸¡ ì¤‘ëŸ‰',
          data: [],
          borderColor: '#00ffff',
          pointBackgroundColor: [],
          fill: false,
          tension: 0.3
        },
        {
          label: 'ì˜ˆì¸¡ ì¤‘ëŸ‰ (ì¶”ì²œ k_rpm)',
          data: [],
          borderColor: '#ffaa00',
          pointBackgroundColor: [],
          fill: false,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      animation: false,
      plugins: {
        legend: { labels: { color: '#ccc' } }
      },
      scales: {
        x: {
          title: { display: true, text: 'Index' },
          ticks: { color: '#ccc' },
          grid: { color: '#444' }
        },
        y: {
          title: { display: true, text: 'ì¤‘ëŸ‰ (g)' },
          min: 2.9,
          max: 3.3,
          ticks: { color: '#ccc' },
          grid: { color: '#444' }
        }
      }
    },
    plugins: [{
        id: 'rpm_change_lines',
        afterDraw(chart) {
          const { ctx, chartArea: { top, bottom }, scales: { x } } = chart;
          ctx.save();
          ctx.strokeStyle = 'red';
          ctx.setLineDash([4, 4]);
          ctx.lineWidth = 1.5;
          const visibleLabels = chart.data.labels;
          changeLineIndexes.forEach(globalIndex => {
            const localIndex = visibleLabels.indexOf(globalIndex);
            if (localIndex === -1) return;
            const xCoord = x.getPixelForValue(localIndex);
            if (isNaN(xCoord)) return;
            ctx.beginPath();
            ctx.moveTo(xCoord, top);
            ctx.lineTo(xCoord, bottom);
            ctx.stroke();
          });

  ctx.restore();
      }
    }]
  });

  // â”€â”€ ëˆ„ì  ì˜¤ì°¨ ì°¨íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const errCanvas = document.getElementById('errorGraph');
  if (!errCanvas || typeof errCanvas.getContext !== 'function') {
    console.error('âŒ errorGraph canvas not found or invalid.');
    return;
  }
  const errCtx = errCanvas.getContext('2d');
  errorChart = new Chart(errCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: 'ì‹¤ì œ ëˆ„ì  ì˜¤ì°¨',
          data: [],
          borderColor: '#ff4444',
          fill: false,
          tension: 0.3
        },
        {
          label: 'ì˜ˆì¸¡ ëˆ„ì  ì˜¤ì°¨',
          data: [],
          borderColor: '#44ff44',
          fill: false,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      animation: false,
      plugins: {
        legend: { labels: { color: '#ccc' } }
      },
      scales: {
        x: {
          title: { display: true, text: 'Index' },
          ticks: { color: '#ccc' },
          grid: { color: '#444' }
        },
        y: {
          title: { display: true, text: 'ì ˆëŒ€ ëˆ„ì  ì˜¤ì°¨' },
          ticks: { color: '#ccc' },
          grid: { color: '#444' }
        }
      }
    }
  });
}

//  4. ì°¨íŠ¸ì— ë°ì´í„° í¬ì¸íŠ¸ ì¶”ê°€
function updateChart(label, real, pred) {
  if (!liveChart) return;

  const maxPoints = 10;

  if (liveChart.data.labels.length >= maxPoints) {
    liveChart.data.labels.shift();
    liveChart.data.datasets[0].data.shift();
    liveChart.data.datasets[1].data.shift();
  }

  liveChart.data.labels.push(label);
  liveChart.data.datasets[0].data.push(real);
  liveChart.data.datasets[1].data.push(pred);

  liveChart.update();
}

//  5. í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
window.addEventListener('DOMContentLoaded', () => {
  loadFullData(); // ì „ì²´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° ì°¨íŠ¸ ì‹¤í–‰
});
</script>

<script>
function startRetraining(event) {
  event.preventDefault();
  copyCycleToManualForm();

  document.getElementById('loadingModal').style.display = 'flex';

  const form = document.getElementById('retrainForm');
  const formData = new FormData(form);

  fetch('/admin/aimodel', {
    method: 'POST',
    body: formData
  })
  .then(res => {
    if (!res.ok) throw new Error('ì¬í•™ìŠµ ì‹¤íŒ¨');
    return res.text();  // ë˜ëŠ” JSON
  })
  .then(result => {
    console.log('ì¬í•™ìŠµ ì™„ë£Œ:', result);
    location.reload();
  })
  .catch(err => {
    document.getElementById('loadingModal').style.display = 'none';
    alert('ì¬í•™ìŠµ ì¤‘ ì˜¤ë¥˜ ë°œìƒ!');
    console.error(err);
  });
}
</script>

{% endblock %}
