{% extends 'admin_base.html' %}
{% block content %}

<!-- âœ… ìŠ¤íƒ€ì¼ ì •ì˜ -->
<style>
/* ğŸ“Œ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ìŠ¤íƒ€ì¼ */
.datepicker-container { position: relative; display: inline-block; }
.datepicker-popup { display: none; position: absolute; top: 30px; z-index: 100; background-color: white; border: 1px solid #ccc; padding: 10px; }
.hidden-input { display: none; }
.calendar-icon { cursor: pointer; }

/* ğŸ“Œ íƒ­ ì½˜í…ì¸  ê¸°ë³¸ ìˆ¨ê¹€, í™œì„± íƒ­ë§Œ grid í‘œì‹œ */
.tab-content { display: none !important;}
.tab-content.active { display: grid !important;}

.dashboard-date-filter {
  display: flex;
  align-items: center;
  gap: 20px;
  padding: 10px 20px;
  background: #000000dc;   
  border-radius: 20px;
  margin-bottom: 20px;
  max-width: 500px;
  border: 1px solid #333333;
  box-shadow: 0 0 7px #00bfff;            /* glow íš¨ê³¼ */
}



/* ğŸ“Œ íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.dashboard-date-filter button {
  background: none;
  border: none;
  color: #aaa;
  font-weight: bold;
  padding: 6px 10px;
  border-bottom: 2px solid transparent;
  cursor: pointer;
}

.dashboard-date-filter button.active {
  color: #00bfff;
  border-bottom: 2px solid #00bfff;
}

.dashboard-date-filter .date-label {
  color: #ccc;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
}

/* ğŸ“Œ ê·¸ë¦¬ë“œ ëŒ€ì‹œë³´ë“œ ë ˆì´ì•„ì›ƒ */
.grid-container {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 20px;
  margin-top: 0px;
  margin-bottom: 30px;
  width: 100%;
}




.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 20px;        /* âœ… ì´ê²ƒë§Œ ì“°ê³  ì•„ë˜ ë‘ ì¤„ ì‚­ì œ */
  /* column-gap: 20px; */
  /* row-gap: 20px; */
  margin-top: 0px;
  margin-bottom: 30px;
  width: 100%;

  
}


.card-1,
.card-2,
.card-3 {
  height: 200px;  /* ë˜ëŠ” card-4ì™€ ë¹„ìŠ·í•œ ë†’ì´ë¡œ */
}


.card {
  background:  #000000dc;  /*#1e1e1e*/
  color: white;
  padding: 10px;
  border-radius: 10px;
  text-align: center;
  font-size: 16px;
  height: 280px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  overflow: hidden;

  border: 1px solid #333333;
  box-shadow: 0 0 7px #00bfff;            /* glow íš¨ê³¼ */
}


/* ğŸ“Œ ì¹´ë“œ ìœ„ì¹˜ ì„¤ì • */
/* ì¼ê°„ */
/* ğŸ³ */
.card-1 { 
  grid-column: 1 / 5;
  background:  #000000dc;  /*#1e1e1e*/
  color: white;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  font-size: 30px;
  height: 150px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden;

 

  border: 1px solid #333333;
  box-shadow: 0 0 7px #00bfff;            /* glow íš¨ê³¼ */
 }
 /* ğŸ³ */
.card-2 { 
  grid-column: 5 / 9;
  background:  #000000dc;  /*#1e1e1e*/
  color: white;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  font-size: 30px;
  height: 150px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start !important; 
  align-items: center;
  overflow: hidden;



  border: 1px solid #333333;
  box-shadow: 0 0 7px #00bfff;            /* glow íš¨ê³¼ */ }
  /* ğŸ³ */
.card-3 { 
  grid-column: 9 / 13; 
  background:  #000000dc;  /*#1e1e1e*/
  color: white;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  font-size: 30px;
  height: 150px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden;

  border: 1px solid #333333;
  box-shadow: 0 0 7px #00bfff;            /* glow íš¨ê³¼ */ }

/* ğŸ³ì¶”ê°€ */
.card-1,
.card-2,
.card-3 {
  grid-column: span 4;
  width: 100%;
  max-width: 100%;
  min-width: 0;
}

.card-4 { 
  grid-column: 1 / 7;
  padding: 0;
  border-radius: 10px;
  text-align: left;
  /* font-size: 30px; */
  /* height: 150px; */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden;
 }
  .chart-wrapper {
  flex: 1;
  width: 100%;
}
.chart-wrapper canvas {
  width: 100% !important;
  height: 100% !important;
}

.card-5 { 
  grid-column: 7 / 13;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  /* font-size: 30px; */
  /* height: 150px; */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden; 
}

.card-6 { 
  grid-column: 1 / 4;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  /* font-size: 30px; */
  /* height: 150px; */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden; }


.card-7 { 
  grid-column: 4 / 7;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  /* font-size: 30px; */
  /* height: 150px; */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden; }
.card-8 { 
  grid-column: 7 / 10;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  /* font-size: 30px; */
  /* height: 150px; */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden; }
.card-9 { 
  grid-column: 10 / 13;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  /* font-size: 30px; */
  /* height: 150px; */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden; }

/* ì£¼ê°„ ë° ì›”ê°„ ì¹´ë“œ */
.card-10 { 
  grid-column: 1 / 7;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  /* font-size: 30px; */
  height: 150px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden; }
.card-11 { 
  grid-column: 7 / 13;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  /* font-size: 30px; */
  height: 150px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden; }
.card-12 { 
  grid-column: 1 / 13;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  /* font-size: 30px; */
  /* height: 150px; */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden; }
.card-13 { 
  grid-column: 1 / 4;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  /* font-size: 30px; */
  /* height: 150px; */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden; }
.card-14 { 
  grid-column: 4 / 7;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  /* font-size: 30px; */
  /* height: 150px; */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden; }
.card-15 { 
  grid-column: 7 / 10;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  /* font-size: 30px; */
  /* height: 150px; */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden; }
.card-16 { 
  grid-column: 10 / 13;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  /* font-size: 30px; */
  /* height: 150px; */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden; }
.card-17 { 
  grid-column: 1 / 7;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  /* font-size: 30px; */
  /* height: 150px; */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden; }
.card-18 { 
  grid-column: 7 / 13;
  padding: 0px;
  border-radius: 10px;
  text-align: left;
  /* font-size: 30px; */
  /* height: 150px; */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: hidden; }

.progress-details {
  white-space: nowrap;       /* âœ… ì¤„ë°”ê¿ˆ ë°©ì§€ */
  color: #ccc;
  font-size: 28px;
  font-weight: 500;
  text-align: center;
  margin-top: 0px;
  line-height: 1.6;
  width: 100%;
  display: block;
  margin: 0 auto;
  padding: 4px 12px;
  font-family: 'Noto Sans KR', sans-serif;
}

/* ğŸ³ */
.progress-details div {
  width: 100%;
  text-align: center;
}

.card h4 {
  /* background-color: rgba(5, 171, 226, 0.15); */
  padding: 6px 12px;
  border-radius: 6px;
  display: block;
  font-weight: bold;
  text-align: left;
  width: 100%;
  font-size: 26px;
  color: rgb(255, 255, 255);
  margin-top: 0px;          /* âœ… ìœ„ ì—¬ë°± ì œê±° */
  margin-bottom: 0px;      /* (ì„ íƒ) ì•„ë˜ ì—¬ë°±ë§Œ ìœ ì§€ */
  align-self: stretch;   /* âœ… ë¶€ëª¨ê°€ centerì—¬ë„ h4ë§Œ ì˜ˆì™¸ë¡œ ì „ì²´ ì±„ì›€ */
}

/* ğŸ³ */
.card-title-wrapper {
  width: 100%;
  padding: 8px 16px;
  box-sizing: border-box;   /* âœ… padding í¬í•¨í•´ì„œ width ê³„ì‚° */
  background-color: rgba(5, 171, 226, 0.15);
  border-radius: 8px 8px 0 0;
}


#dashboard-header {
  position: sticky;
  top: 63px;
  /* left: 80px; */
  width: 100%;
  background-color: #050525;
  z-index: 1000;
  padding-bottom: 0px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.6);
  max-width: none !important;   /* ë¶€ëª¨ ì œí•œ ë¬´ì‹œ */
}

tab-day { margin-top: 10px; }

.card canvas {
  width: 102% !important;
  height: 200px !important;
  object-fit: contain;
}
.card.chart-card canvas {
  height: 100% !important; /* âœ… chart-cardëŠ” ì¹´ë“œ ë†’ì´ì— ë§ê²Œ ê½‰ ì°¨ê²Œ */
}



.chart-wrapper {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ì£¼ê°„ ì›”ë³„ ë§ˆì§€ë§‰ ì¹´ë“œì— ëŒ€í•˜ì—¬ íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ë§ ì§€ì •*/
.chart-tabs {
  display: flex;
  justify-content: flex-start;
  background-color: #1b1b1b;
  padding: 6px 12px;
  border-radius: 8px;
  margin-bottom: 12px;
  list-style: none;
}

.chart-tab {
  padding: 3px 16px;
  font-size: 16px;
  font-weight: bold;
  background-color: #222;
  color: #ccc;
  border: 2px solid #333;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s;
  white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
}

.chart-tab:hover {
  background-color: #333;
  color: #fff;
}

.chart-tab.active {
  background-color: #00bfff;
  color: #fff;
  border-color: #00bfff;
}

.tabs {
  display: flex; /* í•œ ì¤„ ë°°ì¹˜ */
  gap: 10px;
  padding: 10px 10px 0px 0px;
  margin: 0;
  margin-bottom: 4px !important;
  list-style: none;
}

/* â‘  ì°¨íŠ¸ ì¹´ë“œ ì „ì²´ë¥¼ flex-column ì»¨í…Œì´ë„ˆë¡œ */
.card.chart-card {
  display: flex;
  flex-direction: column;
  /* í•„ìš”ì‹œ ë†’ì´ë¥¼ ê°•ì œí•˜ê³  ì‹¶ìœ¼ë©´ grid-auto-rows ë¥¼ ì¡°ì •í•˜ì„¸ìš” */
  /* ì˜ˆ: height: 300px; */
  min-height: 0; /* í•˜ìœ„ flex ì•„ì´í…œì´ ì˜ë¦´ ë•Œ overflow ë°©ì§€ */
}

/* â‘¡ ì°¨íŠ¸ ë˜í¼ê°€ ì¹´ë“œì˜ ë‚¨ì€ ê³µê°„ì„ ì „ë¶€ ì°¨ì§€ */
.card.chart-card .chart-wrapper {
  flex: 1;
  min-height: 0; /* flexboxì—ì„œ ìì‹ ë†’ì´ 100%ê°€ ë¨¹íˆë„ë¡ */
  width: 100%;
}

/* â‘¢ ìº”ë²„ìŠ¤ëŠ” ë˜í¼ í¬ê¸°ì— ì •í™•íˆ ë§ì¶”ê¸° */
.card.chart-card .chart-wrapper canvas {
  width: 100% !important;
  height: 100% !important;
  display: block;


}

/* âœ… card-17, card-18 ì „ìš© - chart-wrapperì™€ canvas ëª¨ë‘ í™•ì¥ */
.card.card-17.chart-card,
.card.card-18.chart-card {
  height: 280px;              /* ì›í•˜ëŠ” ì¹´ë“œ ë†’ì´ */
  display: flex;
  flex-direction: column;
  width: 100%;
}

.card.card-17.chart-card .chart-wrapper,
.card.card-18.chart-card .chart-wrapper {
  width: 100%;
  height: 100%;
  padding: 0; /* í˜¹ì‹œ ì—¬ë°± ìˆìœ¼ë©´ ì œê±° */
  margin: 0;
  display: flex;
  align-items: stretch;
  justify-content: stretch;
  flex: 1;

}

.card.card-17.chart-card .chart-wrapper canvas,
.card.card-18.chart-card .chart-wrapper canvas {
  width: 100% !important;
  height: 100% !important;
  display: block;
  box-sizing: border-box;
  padding-left: 10px;
}

#week_intervention-bar {
  width: 100% !important;
  height: 100% !important;
  display: block;
  box-sizing: border-box;
}

.chart-header {
  display: flex;
  justify-content: space-between;  /* ì™¼ìª½ ì œëª©, ì˜¤ë¥¸ìª½ ë²„íŠ¼ */
  align-items: center;
  width: 100%;
  padding: 0 12px; /* ì¢Œìš° ì—¬ë°± */
  margin-bottom: 12px;
}

.chart-header h4 {
  margin: 0;
  font-size: 26px;
  color: white;
}
/* ========================ì„¼ì„œ */
/* ì‹¤ì‹œê°„ ì„¼ì„œ í˜„í™© í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
#sensor-status-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

#sensor-status-table td {
  padding: 12px 40px;
  font-size: 20px;
  color: #ddd;
  vertical-align: middle;
  border-bottom: 1px solid #333;
}

/* ì„¼ì„œ ì´ë¦„ì€ ì™¼ìª½ ì •ë ¬, ìƒíƒœëŠ” ì˜¤ë¥¸ìª½ ì •ë ¬ */
#sensor-status-table td:first-child {
  text-align: left;
  font-weight: 600;
  color: #ccc;
}

#sensor-status-table td:last-child {
  text-align: right;
  font-weight: bold;
  font-size: 17px;
}


</style>

<!-- âœ… HTML êµ¬ì¡° (ëŒ€ì‹œë³´ë“œ í—¤ë”ì™€ íƒ­ ì˜ì—­) -->
<div id="dashboard-header">
  <h2 style="margin: 0; padding: 20px; color: #fff; font-size: 26px;">
    <img src="/static/images/dashboard_img.png" alt="ëŒ€ì‹œë³´ë“œ ì•„ì´ì½˜" style="width: 40px; height: 40px; vertical-align: middle; margin-right: 10px;">
    Main Dashboard
  </h2>

  <!-- ğŸ“… íƒ­ê³¼ ë‹¬ë ¥ í•„í„° -->
  <div class="dashboard-date-filter">
    <button class="tab-btn date-tab-btn" data-target="tab-day">ì¼</button>
    <button class="tab-btn date-tab-btn" data-target="tab-week">ì£¼</button>
    <button class="tab-btn date-tab-btn" data-target="tab-month">ì›”</button>
    <span class="date-label">
      <span id="calendar-icon" style="cursor: pointer;">ğŸ“…</span>
      <div id="popup-calendar" style="display: none; position: absolute; top: 120px; left: 205px; z-index: 999;">
        <input type="date" id="popup-date-picker" />
      </div>
      <span id="today-date" style="margin-left: 10px;">ë¡œë”© ì¤‘...</span>
    </span>
  </div>
</div>

<!-- âœ… íƒ­ ì½˜í…ì¸  ì˜ì—­ -->
<div id="tab-day" class="dashboard-grid tab-content active"> <!-- ì¼ íƒ­ ì½˜í…ì¸  -->
  <!-- ğŸ³ -->
  <div class="card card-1"><h4 style="color: #00BFFF;">ë‹¹ì¼ ìƒì‚°ëŸ‰</h4><div class="progress-details"><div style=" font-size: 30px;margin-top: 0px; line-height: 1.2;">ëª©í‘œ ìƒì‚°ëŸ‰: <span id="prod-target">--</span></div><div style="font-size: 30px;">ì‹¤ì œ ìƒì‚°ëŸ‰: <span id="prod-actual">--</span></div></div></div>
  <div class="card card-2"><h4 style="color: #FFE26B;">ë‹¹ì¼ ì†ì‹¤ëŸ‰</h4><div class="progress-details"><div style="font-size: 50px; margin-top: 0px; line-height: 1.2;"><span id="loss-actual">-- g</span></div></div></div>
  <div class="card card-3"><h4 style="color: #00FF88;">ë‹¹ì¼ ë§¤ì¶œì•¡</h4><div class="progress-details"><div style="font-size: 50px; margin-top: 0px; line-height: 1.2;"><span id="profit-actual">-- ì›</span></div></div></div>
  <div class="card card-4 chart-card" style="height: 280px;">
    <h4>ì¤‘ëŸ‰ / RPM ì¶”ì´</h4>
    <div class="chart-wrapper">
      <canvas id="rpmChart"></canvas></div>
    </div>
  <div class="card card-5 chart-card" style="height: 280px; padding-right: 20px;">
    <h4 style="color: #FFE26B;">ì‹œê°„ëŒ€ ì†ì‹¤ëŸ‰</h4>
    <div class="chart-wrapper">
      <canvas id="lossChart"></canvas></div>
    </div>
  <div class="card card-6"><h4 >ì‹¤ì‹œê°„ ì„¼ì„œ í˜„í™©</h4><table id="sensor-status-table"></table></div>
  <div class="card card-7"><h4 style="color: #00BFFF;">ì‹¤ì‹œê°„ ìƒì‚°ëŸ‰</h4><div class="chart-wrapper"><canvas id="prodPieChart"></canvas></div></div>
  <div class="card card-8"><h4 style="color: #FFE26B;">ì‹¤ì‹œê°„ ì†ì‹¤ë¥ </h4><div class="chart-wrapper"><canvas id="lossPieChart"></canvas></div></div>
  <div class="card card-9"><h4 style="color: #FF5555;">ì‹¤ì‹œê°„ ë¶ˆëŸ‰ë¥ </h4><div class="chart-wrapper"><canvas id="defectPieChart"></canvas></div></div>
</div>

<!-- ì£¼ê°„/ì›”ê°„ íƒ­ ì½˜í…ì¸  êµ¬ì¡°ëŠ” ìƒëµë¨ (ì˜ˆì‹œë§Œ ìœ ì§€) -->
<div id="tab-week" class="dashboard-grid tab-content">
  <!-- ğŸ³ -->
  <div class="card card-10"><h4 style="color: #00BFFF;">ì£¼ê°„ ì´ ìƒì‚°ëŸ‰</h4><div class="progress-details"><div style="font-size: 50px; margin-top: 0px; line-height: 1.2;"><span id="realtime-week_sum">ë¡œë”© ì¤‘...</span></div></div></div>
  <div class="card card-11"><h4 style="color: #FFE26B;">ì£¼ê°„ ì´ ì†ì‹¤ëŸ‰</h4><div class="progress-details"><div style="font-size: 50px; margin-top: 0px; line-height: 1.2;"><span id="loss-week_cumulative">ë¡œë”© ì¤‘...</span></div></div></div>
  <div class="card card-12 chart-card" style="height: 280px;">
    <h4 style="color: #00FF88;">ì¼ë³„ ë§¤ì¶œì•¡ <span id="weekly-sales-total" style="font-size: 16px; margin-left: 12px; color: #00FF88;"></span></h4>
    <div class="chart-wrapper">
      <canvas id="weekly-sales-bar" class="chart"></canvas>
    </div>
  </div>
  <div class="card card-13"><h4>ì£¼ê°„ ì„¼ì„œ í˜„í™©</h4><table class="week_sensor-table" id="sensor-status-table-week"></table></div>
  <div class="card card-14"><h4 style="color: #00BFFF;">ì£¼ ì´ ìƒì‚°ëŸ‰</h4><canvas id="week_prodPieChart" class="week_chart"></canvas></div>
  <div class="card card-15"><h4 style="color: #FFE26B;">ì£¼ ì´ ì†ì‹¤ë¥ </h4><canvas id="week_lossPieChart" class="week_chart"></canvas></div>
  <div class="card card-16"><h4 style="color: #FF5555;">ì£¼ ì´ ë¶ˆëŸ‰ë¥ </h4><canvas id="week_defectPieChart" class="week_chart"></canvas></div>
  <div class="card card-17 chart-card">
    <h4 style="color: #ffffff;">ì¼ë³„ ì‘ì—…ì ê°œì… ê±´ìˆ˜</h4>
    <div class="chart-wrapper">
      <canvas id="week_intervention-bar"></canvas>
    </div>
  </div>
    
  <div class="card card-18 chart-card" style="height: 280px;">
    <div class="chart-header">
      <h4>ì¼ìë³„ í†µê³„</h4>
      <div class="tabs">
        <button class="tab-btn chart-tab week_chart-tab-btn" data-type="production">ìƒì‚°ëŸ‰</button>
        <button class="tab-btn chart-tab week_chart-tab-btn" data-type="loss">ì†ì‹¤ë¥ </button>
        <button class="tab-btn chart-tab week_chart-tab-btn" data-type="defect">ë¶ˆëŸ‰ë¥ </button>
      </div>
    </div>
    
    <div id="percentage-display" style="font-size: 43px; color: #00ffcc; margin-top: 0px; font-weight: bold;"></div>
    <div class="chart-wrapper">
      <canvas id="weekly-chart"></canvas>
    </div>
  </div>
</div>

<div id="tab-month" class="dashboard-grid tab-content">
  <!-- ğŸ³ -->
 <div class="card card-10"><h4 style="color: #00BFFF;">ì›” ì´ ìƒì‚°ëŸ‰</h4><div class="progress-details"><div style="font-size: 50px; margin-top: 0px; line-height: 1.2;"><span id="realtime-month_sum">ë¡œë”© ì¤‘...</span></div></div></div>
 <div class="card card-11"><h4 style="color: #FFE26B;">ì›” ì´ ì†ì‹¤ëŸ‰</h4><div class="progress-details"><div style="font-size: 50px; margin-top: 0px; line-height: 1.2;"><span id="loss-month_cumulative">ë¡œë”© ì¤‘...</span></div></div></div>
 
 
 <div class="card card-12 chart-card">
  <h4 style="color: #00FF88;">ì£¼ê°„ë³„ ë§¤ì¶œì•¡
    <span id="monthly-sales-total" style="font-size: 16px; margin-left: 12px; color: #00FF88;"></span>
  </h4>
  <div class="chart-wrapper">
    <canvas id="monthly-sales-bar" class="chart"></canvas>
  </div>
</div>
  
  <div class="card card-13"><h4>ì›” ì„¼ì„œ í˜„í™©</h4><table class="month_sensor-table" id="sensor-status-table-month"></table></div>
  <div class="card card-14"><h4 style="color: #00BFFF;">ì›” ì´ ìƒì‚°ëŸ‰</h4><canvas id="month_prodPieChart" class="month_chart"></canvas></div>
  <div class="card card-15"><h4 style="color: #FFE26B;">ì›” ì´ ì†ì‹¤ë¥ </h4><canvas id="month_lossPieChart" class="month_chart"></canvas></div>
  <div class="card card-16"><h4 style="color: #FF5555;">ì›” ì´ ë¶ˆëŸ‰ë¥ </h4><canvas id="month_defectPieChart" class="month_chart"></canvas></div>
  
  <div class="card card-17 chart-card">
    <div class="chart-header">
      <h4 style="color: #ffffff;">ì£¼ê°„ ì‘ì—…ì ê°œì… ê±´ìˆ˜</h4>
    </div>
    <div class="chart-wrapper">
      <canvas id="monthly_intervention-bar" height="200"></canvas>
    </div>
  </div>
    
  <div class="card card-18 chart-card">
    <div class="chart-header">
      <h4>ì£¼ë³„ í†µê³„</h4>
      <div class="tabs">
        <button class="tab-btn chart-tab month_chart-tab-btn" data-type="month_production">ìƒì‚°ëŸ‰</button>
        <button class="tab-btn chart-tab month_chart-tab-btn" data-type="month_loss">ì†ì‹¤ë¥ </button>
        <button class="tab-btn chart-tab month_chart-tab-btn" data-type="month_defect">ë¶ˆëŸ‰ë¥ </button>
      </div>
    </div>
    <!-- ğŸ³ percentage-display => mothly-percentage-displayë¡œ ë³€ê²½(ì´ìœ : id ì¤‘ë³µìœ¼ë¡œ ì´í•©ì´ ì•ˆ ëœ¸) -->
    <div id="monthly-percentage-display" style="font-size: 43px; color: #00ffcc; margin-top: 0px; font-weight: bold;"></div>
    <div class="chart-wrapper">
      <canvas id="monthly-chart"></canvas>
    </div>
  </div>
</div>



<!-- íƒ­ ë™ì‘ ìŠ¤í¬ë¦½íŠ¸ -->

<script>
document.addEventListener('DOMContentLoaded', () => {
  const tabButtons = document.querySelectorAll('.date-tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');

  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const targetId = button.dataset.target;
      const targetTab = document.getElementById(targetId);
      if (!targetTab) return;

      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(tab => tab.classList.remove('active'));

      button.classList.add('active');
      targetTab.classList.add('active');
    });
  });

  const defaultBtn = document.querySelector('.date-tab-btn[data-target="tab-day"]');
  if (defaultBtn) defaultBtn.click(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”

  const today = new Date();
  const formatted = `${today.getFullYear()}.${String(today.getMonth() + 1).padStart(2, '0')}.${String(today.getDate()).padStart(2, '0')}`;
  document.getElementById('today-date').textContent = formatted;
});
</script>

<!-- ì£¼,ì›” ë°ì´í„° ì„ íƒ ì‹œ ë‚˜ì˜¤ëŠ” ë‹¬ë ¥ í‘œì‹œ-->
<script>
// âœ… ë‹¬ë ¥ ì•„ì´ì½˜ í´ë¦­ ì‹œ input[type="date"] í† ê¸€
document.getElementById('calendar-icon').addEventListener('click', () => {
  const calendarPopup = document.getElementById('popup-calendar');
  calendarPopup.style.display = (calendarPopup.style.display === 'block') ? 'none' : 'block';
});

// âœ… ë‹¬ë ¥ ì˜ì—­ ì™¸ í´ë¦­ ì‹œ ë‹¬ë ¥ ë‹«í˜
document.addEventListener('click', (e) => {
  const calendarContainer = document.querySelector('.date-label');
  if (!calendarContainer.contains(e.target)) {
    document.getElementById('popup-calendar').style.display = 'none';
  }
});

// âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
document.addEventListener('DOMContentLoaded', () => {
  const picker = document.getElementById('popup-date-picker');
  const today = new Date().toISOString().split('T')[0];
  picker.value = today;
  picker.dispatchEvent(new Event('change')); // ê¸°ë³¸ ì£¼ê°„ ë°ì´í„° ìë™ ë¡œë“œ
});
</script>


<!-- ì¼ íƒ­ -->
<script>
//                           ì¼ìíƒ­   1í–‰
// ========================== ë³€ìˆ˜ ì„ ì–¸ ==========================
let prodIndex = 0, prodSum = 0, prodValues = [];
let lossIndex = 0, lossSum = 0, lossValues = [];
let profitIndex = 0, profitSum = 0;

// âœ… ëª©í‘œê°’ ì„¤ì •
const prodTarget = 2000;     // g
const profitTarget = 20000;  // ì›

// ========================== API í˜¸ì¶œ ==========================
function fetchValues() {
  fetch('/api/production')
    .then(res => res.json())
    .then(data => {
      prodValues = data.values || [];
      lossValues = data.loss_values || [];

      updateAll();

      setInterval(updateAll, 500);
    })
    .catch(err => {
      console.error("ğŸš¨ API í˜¸ì¶œ ì‹¤íŒ¨:", err);
    });
}

// ========================== ê°±ì‹  í•¨ìˆ˜ ë¬¶ìŒ ==========================
function updateAll() {
  updateProduction();
  updateLoss();
  updateProfit();
  updateTargetDisplay();
}

// ========================== ìƒì‚°ëŸ‰ ì—…ë°ì´íŠ¸ ==========================
function updateProduction() {
  if (prodIndex < prodValues.length) {
    prodSum += prodValues[prodIndex];
    prodIndex++;
  }
  document.getElementById("prod-actual").textContent = `${prodSum.toFixed(2)} g`;
}

// ========================== ì†ì‹¤ëŸ‰ ì—…ë°ì´íŠ¸ ==========================
function updateLoss() {
  if (lossIndex < lossValues.length) {
    lossSum += lossValues[lossIndex];
    lossIndex++;
  }
  document.getElementById("loss-actual").textContent = `${lossSum.toFixed(2)} g`;
}

// ========================== ë§¤ì¶œì•¡ ì—…ë°ì´íŠ¸ ==========================
function updateProfit() {
  if (profitIndex < prodValues.length) {
    const gram = prodValues[profitIndex];
    profitSum += gram * 7; // ë‹¨ê°€ â‚©7
    profitIndex++;
  }
  document.getElementById("profit-actual").textContent = `${profitSum.toFixed(2)} ì›`;
}

// ========================== ëª©í‘œê°’ í…ìŠ¤íŠ¸ ì„¤ì • ==========================
function updateTargetDisplay() {
  document.getElementById("prod-target").textContent = `${prodTarget.toLocaleString()} g`;
  // document.getElementById("profit-target").textContent = `${profitTarget.toLocaleString()} ì›`;
}

// ========================== ì‹¤í–‰ ì‹œì‘ ==========================
window.addEventListener('DOMContentLoaded', fetchValues);
</script>

<script>
// ===================================================================================================================================================
//                          ì¼ìíƒ­   2í–‰

// ========================== RPM & ì¤‘ëŸ‰ ì°¨íŠ¸ ==========================
function drawRpmChart() {
  fetch('/api/production')
    .then(res => res.json())
    .then(data => {
      const scaleData = data.values;
      const rpmData = data.k_rpm_pv;
      const ctx = document.getElementById('rpmChart').getContext('2d');

      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'ì¤‘ëŸ‰ (scale_pv)',
              data: [],
              borderColor: '#00ffff',
              yAxisID: 'y-left',
              fill: false,
              tension: 0.3
            },
            {
              label: 'RPM (k_rpm_pv)',
              data: [],
              borderColor: '#ff4444',
              yAxisID: 'y-right',
              fill: false,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          scales: {
            x: {
              title: { display: true, text: 'ì‹œê°„(HH:MM:SS)' },
              ticks: { color: '#ccc' },
              grid: { color: '#333' }
            },
            'y-left': {
              position: 'left',
              title: { display: true, text: 'ì¤‘ëŸ‰ (g)' },
              ticks: { color: '#ccc' },
              grid: { color: '#333' },
              min: 2.7,
              max: 5
            },
            'y-right': {
              position: 'right',
              title: { display: true, text: 'RPM' },
              ticks: { color: '#ccc' },
              grid: { drawOnChartArea: false },
              min: 140,
              max: 200
            }
          },
          plugins: {
            legend: {
              labels: { color: '#ccc' }
            }
          }
        }
      });

      let index = 0;
      setInterval(() => {
        if (index < scaleData.length) {
          const now = new Date();
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          const seconds = String(now.getSeconds()).padStart(2, '0');
          const formattedTime = `${hours}:${minutes}:${seconds}`;   
          const label = formattedTime

          if (chart.data.labels.length >= 10) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
            chart.data.datasets[1].data.shift();
          }

          chart.data.labels.push(label);
          chart.data.datasets[0].data.push(scaleData[index]);
          chart.data.datasets[1].data.push(rpmData[index]);
          chart.update();

          index++;
        }
      }, 500);
    });
}

// ========================== ì‹œê°„ëŒ€ë³„ ì†ì‹¤ ì°¨íŠ¸ ==========================
function drawLossByHourChart() {
  const redLossCount = Array(24).fill(0);
  const hours = Array.from({ length: 24 }, (_, i) => i.toString());

  const ctx = document.getElementById('lossChart').getContext('2d');
  const lossChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: hours,
      datasets: [{
        label: 'ë¡œìŠ¤ ê°œìˆ˜',
        data: redLossCount,
        backgroundColor: '#FFE26B',
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          title: { display: true, text: 'ì‹œê°„ëŒ€ (0~23ì‹œ)' },
          ticks: { color: '#ccc' },
          grid: { color: '#333' }
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: 'ë¹¨ê°„ ì  ìˆ˜' },
          ticks: { color: '#ccc' },
          grid: { color: '#333' }
        }
      },
      plugins: {
        legend: {
          labels: { color: '#ccc' }
        }
      }
    }
  });

  setInterval(() => {
    const currentHour = new Date().getHours();
    redLossCount[currentHour]++;
    lossChart.update();
  }, 1000);
}

// ========================== ì‹¤í–‰ ì‹œì‘ ==========================
window.addEventListener('DOMContentLoaded', () => {
  drawRpmChart();
  drawLossByHourChart();
});

</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ===================================================================================================================================================
//                          ì¼ìíƒ­   3í–‰

 // ğŸ“¦ ì „ì—­ ë³€ìˆ˜
let sensorData = null;                   // APIì—ì„œ ê°€ì ¸ì˜¨ ì„¼ì„œ ê´€ë ¨ JSON ë°ì´í„°ë¥¼ ì €ì¥í•  ë³€ìˆ˜
let sensorIndex = 0;                     // ì„¼ì„œ ìƒíƒœ í…Œì´ë¸” ìˆœí™˜ ì¸ë±ìŠ¤ (ì‹œê°„ íë¦„ì²˜ëŸ¼ í‘œì‹œ)
let pieIndex = 0;                        // íŒŒì´ ì°¨íŠ¸ ê°±ì‹  ì¸ë±ìŠ¤

let pieProdChart, pieLossChart, pieDefectChart;  // Chart.jsë¡œ ìƒì„±í•œ íŒŒì´ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ 3ì¢…

// ì•„ë˜ ë‘ ë³€ìˆ˜ëŠ” ì£¼ì„ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ ì „ì—­ì—ì„œ ë”°ë¡œ ì„ ì–¸ë˜ì–´ì•¼ í•¨
// let prodValues_pie = [];              // (ì£¼ì„ ì²˜ë¦¬ëœ) ìƒì‚°ëŸ‰ ë°°ì—´
// let lossValues_pie = [];              // (ì£¼ì„ ì²˜ë¦¬ëœ) ì†ì‹¤ëŸ‰ ë°°ì—´
let defectValues = [];                   // ë¶ˆëŸ‰ ì—¬ë¶€ (1: ë¶ˆëŸ‰, 0: ì •ìƒ) ë°°ì—´


// âœ… ì„¼ì„œ ë° ìƒì‚° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (API í˜¸ì¶œ)
async function fetchSensorData() {
  try {
    const res = await fetch('/api/production');     // ì„œë²„ì—ì„œ ìƒì‚°/ì„¼ì„œ ë°ì´í„° ìš”ì²­
    const data = await res.json();                  // ì‘ë‹µ JSON íŒŒì‹±

    sensorData = data;                              // ì„¼ì„œ ê´€ë ¨ ì´ìƒì¹˜ ë°ì´í„°ë¥¼ ì €ì¥
    prodValues = data.values || [];                 // ìƒì‚°ëŸ‰ ë°ì´í„° (ë°°ì—´)
    lossValues = data.loss_values || [];            // ì†ì‹¤ëŸ‰ ë°ì´í„° (ë°°ì—´)
    defectValues = data.defect_values || [];        // ë¶ˆëŸ‰ ì—¬ë¶€ ë°°ì—´

    updateSensorStatusTable();                      // ì„¼ì„œ í…Œì´ë¸” ì´ˆê¸° ì—…ë°ì´íŠ¸
  } catch (err) {
    console.error("ğŸš¨ ì„¼ì„œ ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨:", err); // ì˜¤ë¥˜ ë¡œê·¸ ì¶œë ¥
  }
};

// âœ… ì„¼ì„œ ìƒíƒœ í…Œì´ë¸” ê°±ì‹  (âŒ / âœ…)
function updateSensorStatusTable() {
  if (!sensorData) return; // ë°ì´í„° ì—†ìœ¼ë©´ ì¤‘ë‹¨

  const table = document.getElementById('sensor-status-table');
  if (!table) return; // í…Œì´ë¸” ìš”ì†Œ ì—†ìœ¼ë©´ ì¤‘ë‹¨

  // ê° ì„¼ì„œë³„ í‚¤ì™€ ì´ë¦„ ì •ì˜
  const rows = [
    { name: 'ì‚¬ì¶œ ì˜¨ë„', key: 'n_temp_pv_is_outlier' },
    { name: 'ì±”ë²„ ì˜¨ë„', key: 'c_temp_pv_is_outlier' },
    { name: 'RPM', key: 'k_rpm_pv_is_outlier' },
    { name: 'ìŠ¤í¬ë¥˜ ì†ë„', key: 'E_scr_pv_is_outlier' },
    { name: 'ìŠ¤í¬ë¥˜ ì˜¨ë„', key: 's_temp_pv_is_outlier' }
  ];

  table.innerHTML = ''; // ê¸°ì¡´ í…Œì´ë¸” ë‚´ìš© ì´ˆê¸°í™”

  rows.forEach(sensor => {
    const arr = sensorData[sensor.key];                          // í•´ë‹¹ ì„¼ì„œ ë°ì´í„° ë°°ì—´
    const isOutlier = sensorIndex < arr.length ? arr[sensorIndex] : false; // í˜„ì¬ ì¸ë±ìŠ¤ì˜ ì´ìƒ ì—¬ë¶€

    // í…Œì´ë¸” í–‰ êµ¬ì„±
    const row = document.createElement('tr');
    row.innerHTML = `<td>${sensor.name}</td>
                     <td style="font-size: 20px; color: ${isOutlier ? '#ff4477' : '#00ff00'};">
                       ${isOutlier ? '<span style="color: #FF5555;">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</span>' : '<span style="color: #00cc66;">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</span>'}
                     </td>`;
    table.appendChild(row);  // í…Œì´ë¸”ì— í–‰ ì¶”ê°€
  });

  // ë‹¤ìŒ ìˆœí™˜ ì¸ë±ìŠ¤ë¡œ ì´ë™ (ë°˜ë³µì ìœ¼ë¡œ ëŒê¸° ìœ„í•¨)
  sensorIndex = (sensorIndex + 1) % (sensorData['k_rpm_pv_is_outlier']?.length || 1);
}

// âœ… íŒŒì´ ì°¨íŠ¸ ì´ˆê¸°í™” (Chart.js ì‚¬ìš©)
function initPieCharts() {
  pieProdChart = createPieChart('prodPieChart', ['ìƒì‚°', 'ë‚¨ì€ ì–‘'], [0, 100], ['#00BFFF', '#333']);
  pieLossChart = createPieChart('lossPieChart', ['ì†ì‹¤', 'ì •ìƒ'], [0, 100], ['#FFE26B', '#333']);
  pieDefectChart = createPieChart('defectPieChart', ['ë¶ˆëŸ‰', 'ì •ìƒ'], [0, 1], ['#FF5555', '#333']);
}

// âœ… Chart.js íŒŒì´ ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜ (ìº”ë²„ìŠ¤ IDë³„ë¡œ ì°¨íŠ¸ ìƒì„±)

function createPieChart(id, labels, data, colors) {
  const ctx = document.getElementById(id).getContext('2d');
  const centerTextPlugin = {
  id: 'centerText',
  beforeDraw(chart) {
    const { ctx, width, height, data } = chart;

    // â‘  ë°ì´í„° ë°°ì—´ì„ ìˆ«ìë¡œ ë°”ê¿”ì„œ
    const values = data.datasets[0].data.map(v => Number(v) || 0);
    const sum    = values.reduce((a, b) => a + b, 0) || 1;
    // â‘¡ ì²« ë²ˆì§¸ ì¡°ê°(ì˜ˆ: ìƒì‚°ëŸ‰)ì˜ ë¹„ìœ¨ ê³„ì‚°
    const pct    = ((values[0] / sum) * 100).toFixed(1) + '%';

    // â‘¢ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
    ctx.save();
    ctx.font = 'bold 24px sans-serif';
    ctx.fillStyle = '#fff';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top' ;
    ctx.fillText(pct, width / 2, height / 2);
    ctx.restore();
  }
};

  return new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: colors
      }]
    },
    options: {
      maintainAspectRatio: false,
      cutout: '75%',
      plugins: {
        legend: { labels: { color: '#fff' } },
        // datalabels ì„¤ì •ì€ í•„ìš” ì—†ìœ¼ì‹œë©´ ì§€ì›Œë„ ë©ë‹ˆë‹¤
      }
    },
    // DataLabelsë‘ í•¨ê»˜ ì“°ì‹¤ ê±°ë©´ ë‘ ê°œ, 
    // ì¤‘ì•™ í…ìŠ¤íŠ¸ë§Œ ì›í•˜ì‹œë©´ centerTextPluginë§Œ ë„£ìœ¼ì„¸ìš”.
    plugins: [ centerTextPlugin ]
  })};

// âœ… íŒŒì´ ì°¨íŠ¸ ê°±ì‹  í•¨ìˆ˜ (step-by-stepìœ¼ë¡œ ìƒì‚°/ì†ì‹¤/ë¶ˆëŸ‰ë¥  ì‹œê°í™”)
function updatePieCharts() {
  if (pieIndex >= prodValues.length) return; // ëª¨ë“  ê°’ í‘œì‹œ ì™„ë£Œë˜ë©´ ì¢…ë£Œ

  // ëˆ„ì  ìƒì‚°ëŸ‰ ê³„ì‚°
  const produced = prodValues.slice(0, pieIndex + 1).reduce((a, b) => a + b, 0);
  const totalTarget = 2500; // ëª©í‘œ ìƒì‚°ëŸ‰
  const remaining = Math.max(0, totalTarget - produced); // ë‚¨ì€ ì–‘ ê³„ì‚°

  // ëˆ„ì  ì†ì‹¤ëŸ‰ ë° ì •ìƒ ìƒì‚°ëŸ‰ ê³„ì‚°
  const loss = lossValues.slice(0, pieIndex + 1).reduce((a, b) => a + b, 0);
  const normal = Math.max(0, produced - loss);

  // ë¶ˆëŸ‰ ê°œìˆ˜ ë° ì •ìƒ ê°œìˆ˜ ê³„ì‚°
  const defectTotal = defectValues.slice(0, pieIndex + 1).length;
  const defectCount = defectValues.slice(0, pieIndex + 1).filter(v => v === 1).length;
  const normalCount = defectTotal - defectCount;

  // íŒŒì´ ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
  pieProdChart.data.datasets[0].data = [produced.toFixed(2), remaining.toFixed(2)];
  pieLossChart.data.datasets[0].data = [loss.toFixed(2), normal.toFixed(2)];
  pieDefectChart.data.datasets[0].data = [defectCount, normalCount];

  // ì°¨íŠ¸ ê°±ì‹  ì ìš©
  pieProdChart.update();
  pieLossChart.update();
  pieDefectChart.update();

  pieIndex++; // ë‹¤ìŒ ì¸ë±ìŠ¤ë¡œ ì´ë™
}

// âœ… í˜ì´ì§€ ë¡œë”© ì™„ë£Œ ì‹œ ì‹¤í–‰ë˜ëŠ” ì´ˆê¸°í™” ì½”ë“œ
window.addEventListener('DOMContentLoaded', () => {
  initPieCharts();         // íŒŒì´ ì°¨íŠ¸ ì´ˆê¸°í™”
  fetchSensorData();       // ì„¼ì„œ + ìƒì‚° ë°ì´í„° API í˜¸ì¶œ

  // ì£¼ê¸°ì  ìë™ ê°±ì‹  ì„¤ì •
  setInterval(updateSensorStatusTable, 1000);  // ì„¼ì„œ ìƒíƒœ í…Œì´ë¸” 1ì´ˆë§ˆë‹¤ ê°±ì‹ 
  setInterval(updatePieCharts, 1000);          // íŒŒì´ ì°¨íŠ¸ë„ 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
});
// ===================================================================================================================================================
</script>



<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<!-- ì£¼ íƒ­ -->
<script>
// âœ… ì „ì—­ ë³€ìˆ˜ ì •ì˜
let weeklyData = null;
let weeklyChartRefs = {}; // Chart.js ì¸ìŠ¤í„´ìŠ¤ ì¬ì‚¬ìš©ìš© ì €ì¥ì†Œ
const weekLabelsKor = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];

// âœ… ê¸°ì¤€ ë‚ ì§œë¡œë¶€í„° í•´ë‹¹ ì£¼(ì›”~ì¼)ì˜ ë‚ ì§œ ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸ ìƒì„±
function getWeeklyDateStrings(baseDate) {
  const date = new Date(baseDate);
  const mondayOffset = (date.getDay() + 6) % 7;
  date.setDate(date.getDate() - mondayOffset);

  return Array.from({ length: 7 }, (_, i) => {
    const d = new Date(date);
    d.setDate(date.getDate() + i);
    return d.toISOString().split('T')[0];
  });
}

// âœ… ê¸°ì¤€ ë‚ ì§œë¡œë¶€í„° í•´ë‹¹ ì£¼(ì›”~ì¼)ì˜ Date ê°ì²´ ë¦¬ìŠ¤íŠ¸ ìƒì„±
function getWeeklyDateRange(baseDateStr) {
  const date = new Date(baseDateStr);
  const offset = (date.getDay() + 6) % 7;
  const monday = new Date(date);
  monday.setDate(date.getDate() - offset);

  return Array.from({ length: 7 }, (_, i) => {
    const d = new Date(monday);
    d.setDate(monday.getDate() + i);
    return d;
  });
}

// âœ… ì „ì²´ ë°ì´í„°ë¥¼ ì„œë²„ì—ì„œ ë¹„ë™ê¸° ë¡œë”©
async function fetchWeeklyData() {
  const res = await fetch('/api/production_all');
  return await res.json();
}

// âœ… ì£¼ê°„ ìƒì‚°, ì†ì‹¤, ë¶ˆëŸ‰ ìš”ì•½
function summarizeWeek(data, weekDates) {
  const { labels_all, values_all, loss_values_all, defect_values_all } = data;
  let total = { prod: 0, loss: 0, defect: 0, count: 0 };

  labels_all.forEach((label, i) => {
    const day = label.split(' ')[0];
    if (weekDates.includes(day)) {
      total.prod += values_all[i] || 0;
      total.loss += loss_values_all[i] || 0;
      total.defect += defect_values_all[i] || 0;
      total.count++;
    }
  });

  return total;
}

// âœ… ì£¼ê°„ ìƒì‚°/ì†ì‹¤ í…ìŠ¤íŠ¸ í‘œì‹œ
function renderWeeklyProductionText(total) {
  document.getElementById('realtime-week_sum').textContent = `${total.prod.toFixed(2)} g`;
}

function renderWeeklyLossText(total) {
  document.getElementById('loss-week_cumulative').textContent = `${total.loss.toFixed(2)} g`;
}

function createOrUpdatePieChart(id, chartRef, labels, data, colors) {
  const canvas = document.getElementById(id);
  if (!canvas || !canvas.getContext) {
    console.warn(`âš ï¸ Canvas with id=${id} not found.`);
    return;
  }
  const ctx = canvas.getContext('2d');

  // í¼ì„¼íŠ¸ ì¤‘ì•™ í…ìŠ¤íŠ¸ìš© í”ŒëŸ¬ê·¸ì¸
  const centerTextPlugin = {
    id: 'centerText',
    beforeDraw(chart) {
      const { ctx, width, height, data } = chart;
      const values = data.datasets[0].data.map(v => Number(v) || 0);
      const sum = values.reduce((a, b) => a + b, 0) || 1;
      const pct = ((values[0] / sum) * 100).toFixed(1) + '%';

      ctx.save();
      ctx.font = 'bold 40px sans-serif'; // âœ… ì¤‘ì•™ í…ìŠ¤íŠ¸: 30px
      ctx.fillStyle = '#fff';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(pct, width / 2, height / 2);
      ctx.restore();
    }
  };

  // ê¸°ì¡´ ì°¨íŠ¸ ì œê±° (ì˜µì…˜ ê°•ì œ ì ìš© ìœ„í•´)
  if (chartRef[id]) {
    chartRef[id].destroy();
  }

  // ìƒˆ ì°¨íŠ¸ ìƒì„±
  chartRef[id] = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: colors
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%',
      plugins: {
        legend: {
          position: 'top',
          labels: {
            color: '#fff',
            font: {
              size: 20,       // âœ… ë²”ë¡€ í°íŠ¸: 20px
              weight: 'bold',
              family: 'sans-serif'
            },
            padding: 16
          }
        },
        tooltip: {
          bodyFont: {
            size: 16
          },
          callbacks: {
            label: function (context) {
              const label = context.label || '';
              const value = context.raw || 0;
              return `${label}: ${value}`;
            }
          }
        }
      },
      layout: {
        padding: {
          top: 0,
          bottom: 0
        }
      }
    },
    plugins: [centerTextPlugin]
  });
}



// âœ… íŒŒì´ì°¨íŠ¸ 3ì¢… ì—…ë°ì´íŠ¸
function updateWeeklyPieCharts(total) {
  const goal = 2500;
  createOrUpdatePieChart('week_prodPieChart', weeklyChartRefs, ['ìƒì‚°', 'ë¯¸ë‹¬'], [total.prod, Math.max(0, goal - total.prod)], ['#00BFFF', '#333']);
  createOrUpdatePieChart('week_lossPieChart', weeklyChartRefs, ['ì†ì‹¤', 'ì •ìƒ'], [total.loss, Math.max(0, total.prod - total.loss)], ['#FFE26B', '#333']);
  createOrUpdatePieChart('week_defectPieChart', weeklyChartRefs, ['ë¶ˆëŸ‰', 'ì •ìƒ'], [total.defect, total.count - total.defect], ['#FF5555', '#333']);
}

// âœ… ì„¼ì„œ ìƒíƒœ í…Œì´ë¸” ë Œë”ë§
function renderWeeklySensorStatus(data, weekDates) {
  const keys = {
    'ì‚¬ì¶œ ì˜¨ë„': 'n_temp_pv_all_is_outlier',
    'ì±”ë²„ ì˜¨ë„': 'c_temp_pv_all_is_outlier',
    'RPM': 'k_rpm_pv_all_is_outlier',
    'ìŠ¤í¬ë¥˜ ì†ë„': 'E_scr_pv_all_is_outlier',
    'ìŠ¤í¬ë¥˜ ì˜¨ë„': 's_temp_pv_all_is_outlier'
  };

  const counts = {};
  Object.entries(keys).forEach(([label, key]) => {
    const series = data[key];
    let count = 0;
    data.labels_all.forEach((time, i) => {
      const dateStr = time.split(' ')[0];
      if (weekDates.includes(dateStr) && series[i] === 0) count++;
    });
    counts[label] = count;
  });

  const table = document.getElementById('sensor-status-table-week');
  if (!table) return;
  table.innerHTML = '';
  Object.entries(counts).forEach(([name, cnt]) => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${name}</td><td style="font-weight:bold; color:${cnt > 0 ? '#ff4444' : '#00ff00'}">${cnt} íšŒ</td>`;
    table.appendChild(row);
  });
}

function renderWeeklyInterventionChart(data, weekDates) {
  const pvSeries = data.scale_pv_all;
  const labels = data.labels_all;

  const dayMap = {};
  weekDates.forEach(d => { dayMap[d] = 0; });

  let currentDate = null;
  let streak = 0;

  for (let i = 0; i < labels.length; i++) {
    const dateStr = labels[i].split(' ')[0];
    const val = pvSeries[i];

    if (!weekDates.includes(dateStr)) continue;

    if (currentDate !== dateStr) {
      currentDate = dateStr;
      streak = 0;
    }

    if (val < 2.9 || val > 3.3) {
      streak++;
      if (streak === 20) {
        dayMap[dateStr]++;
        streak = 0; // ì´ˆê¸°í™”
      }
    } else {
      streak = 0;
    }
  }

  const labelsKor = weekDates.map(d => {
    const dd = new Date(d);
    const dayName = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][dd.getDay()];
    return `${d.slice(5)} (${dayName})`;
  });

  const counts = weekDates.map(d => dayMap[d] || 0);

  const ctx = document.getElementById('week_intervention-bar')?.getContext('2d');
  if (!ctx) return;

  if (weeklyChartRefs.intervention) {
    weeklyChartRefs.intervention.data.labels = labelsKor;
    weeklyChartRefs.intervention.data.datasets[0].data = counts;
    weeklyChartRefs.intervention.update();
  } else {
    weeklyChartRefs.intervention = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labelsKor,
        datasets: [{
          label: 'ì‘ì—…ì ê°œì…',
          data: counts,
          backgroundColor: '#ffaa00',
          barPercentage: 0.5,
          categoryPercentage: 0.7
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: {
            top: 5,
            left: 5
          }
        },
        plugins: {
          legend: { display: false },
          datalabels : {
          anchor: 'end',
          align: 'top',
          formatter: v => v.toLocaleString(),
          color: '#fff',
          font: { weight: 'bold', size: 16 }
        },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.parsed.y} íšŒ`
            }
          }
        },
        scales: {
          y: {
            grid: {color: '#333'},
            beginAtZero: true,
            ticks: { color: '#ccc', font: {size: 18, weight: 'bold'} }
          },
          x: { grid: {color: '#333'}, ticks: { color: '#ccc', font: {size: 18, weight: 'bold'}  } }
        }
      },
      plugins: [ChartDataLabels]
    });
  }
}

// âœ… ë§¤ì¶œ ì°¨íŠ¸ ìƒì„±
function renderWeeklySalesChart(selectedDate) {
  if (!weeklyData) return;
  const weekRange = getWeeklyDateRange(selectedDate);
  const dailyGrams = new Array(7).fill(0);
  const labels = weeklyData.labels_all;
  const values = weeklyData.values_all;

  labels.forEach((label, i) => {
    const d = new Date(label);
    weekRange.forEach((target, idx) => {
      if (d.toDateString() === target.toDateString()) {
        dailyGrams[idx] += values[i] || 0;
      }
    });
  });

  const PRICE_PER_GRAM = 5;
  const sales = dailyGrams.map(g => +(g * PRICE_PER_GRAM).toFixed(2));
  const total = sales.reduce((sum, v) => sum + v, 0).toLocaleString();
  const totalEl = document.getElementById('weekly-sales-total');
  if (totalEl) totalEl.textContent = `(ì´ ë§¤ì¶œ: â‚©${total})`;
  const ctx = document.getElementById('weekly-sales-bar')?.getContext('2d');
  if (!ctx) return;

  const formattedLabels = weekRange.map(d => {
    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    const month = String(d.getMonth() + 1).padStart(2, '0'); // 1~12
    const date = String(d.getDate()).padStart(2, '0');       // 01~31
    const day = days[d.getDay()];
    return `${month}-${date} (${day})`; // âœ… ì˜ˆ: "06-10 (í™”)"
  });

  if (weeklyChartRefs.sales) {
    weeklyChartRefs.sales.data.labels = formattedLabels;
    weeklyChartRefs.sales.data.datasets[0].data = sales;
    weeklyChartRefs.sales.update();
  } else {
    weeklyChartRefs.sales = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: formattedLabels,
        datasets: [{ label: 'ë§¤ì¶œ (â‚©)', data: sales, backgroundColor: '#00FF88', barPercentage: 0.4, categoryPercentage: 0.7 }]
      },
      options: {
        maintainAspectRatio: false,
        layout: {
          padding: {
            top: 20,
            bottom: 10,
            left: 30
          }
        },
        plugins: {
          legend: { display: false },
          datalabels : {
          anchor: 'end',
          align: 'top',
          formatter: v => v.toLocaleString(),
          color: '#fff',
          font: { size: 16 ,weight: 'bold' }
        },
          tooltip: {
            callbacks: {
              label: ctx => `â‚©${ctx.parsed.y.toLocaleString()}`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: '#333' },
            ticks: {
              color: '#ccc',
              font: { size: 18, weight: 'bold' },
              callback: val => 'â‚©' + Number(val).toLocaleString()
            }
          },
          x: { grid: { color: '#333' }, ticks: { color: '#ccc', font: {size:18, weight: 'bold'} } }
        }
      },
      plugins: [ ChartDataLabels ]
    });
  }
}

function renderWeeklyBarChart(type, selectedDate) {
  if (!weeklyData) return;

  const weekRange = getWeeklyDateRange(selectedDate);
  const labels = weeklyData.labels_all;
  const values = (type === 'production') ? weeklyData.values_all :
                 (type === 'loss') ? weeklyData.loss_values_all :
                 weeklyData.defect_values_all;

  const daysKor = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

  // âœ… isoDateì™€ ì¶œë ¥ìš© label ìŒìœ¼ë¡œ êµ¬ì„±
  const labelObjects = weekRange.map(d => {
    const isoDate = d.toISOString().split('T')[0];
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const date = String(d.getDate()).padStart(2, '0');
    const day = daysKor[d.getDay()];
    const label = `${month}-${date} (${day})`;
    return { isoDate, label };
  });

  // âœ… ë°ì´í„° ëˆ„ì ìš© map ì´ˆê¸°í™”
  const dailySumMap = {};
  labelObjects.forEach(obj => dailySumMap[obj.isoDate] = 0);

  labels.forEach((label, i) => {
    const dateStr = label.split(' ')[0];
    if (dailySumMap[dateStr] !== undefined) {
      dailySumMap[dateStr] += values[i] || 0;
    }
  });

  // âœ… ë¼ë²¨ê³¼ ëŒ€ì‘ë˜ëŠ” ë°ì´í„° ë°°ì—´ ì¶”ì¶œ
  const finalLabels = labelObjects.map(obj => obj.label);
  const dataPoints = labelObjects.map(obj => +(dailySumMap[obj.isoDate] || 0).toFixed(2));

  const sum = dataPoints.reduce((a, b) => a + b, 0).toFixed(2);
  const unit = (type === 'defect') ? 'ê±´' : 'g';
  document.getElementById('percentage-display').textContent = `ì´í•©: ${sum} ${unit}`;

  const ctx = document.getElementById('weekly-chart')?.getContext('2d');
  if (!ctx) return;

  if (weeklyChartRefs.bar) {
    weeklyChartRefs.bar.data.labels = finalLabels;
    weeklyChartRefs.bar.data.datasets[0].data = dataPoints;
    weeklyChartRefs.bar.update();
  } else {
    weeklyChartRefs.bar = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: finalLabels,
        datasets: [{ label: type, data: dataPoints, backgroundColor: '#00ffcc' }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,  // âœ… ì´ ì¤„ì´ ìˆì–´ì•¼ í•¨!!

        plugins: { legend: { display: false },        datalabels : {
          anchor: 'end',
          align: 'top',
          formatter: v => v.toLocaleString(),
          color: '#fff',
          font: { weight: 'bold', size: 16 }
        } },

        scales: {
          y: {
            grid: { color: '#333' },
            beginAtZero: true,
            ticks: {
              color: '#ccc',
              font: {size:18, weight: 'bold'},
              callback: val => (type === 'defect' ? val : val + 'g')
            }
          },
          x: { grid: { color: '#333' }, ticks: { color: '#ccc', font: {size: 18, weight: 'bold'} } }
        }
      },
    plugins: [ChartDataLabels]
    });
  }
}


// âœ… íƒ­ í´ë¦­ ì‹œ ë§‰ëŒ€ ì°¨íŠ¸ ë³€ê²½
function setupWeeklyChartTabs() {
  document.querySelectorAll('.chart-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const type = tab.dataset.type;
      const selectedDate = document.getElementById('popup-date-picker').value;
      renderWeeklyBarChart(type, selectedDate);
    });
  });
}

// ì£¼ê°„ ì„¼ì„œ ì´ìƒ ì°¾ê¸° í•¨ìˆ˜ 

function renderWeeklySensorStatusCounts(data, weekDates) {
  // ì„¼ì„œë³„ í•„ë“œëª… ë§¤í•‘: í‘œì‹œí•  ì„¼ì„œ ì´ë¦„ê³¼ data ê°ì²´ ì†ì„± í‚¤
  const sensorKeys = {
    'ì‚¬ì¶œ ì˜¨ë„': 'n_temp_pv_all_is_outlier',
    'ì±”ë²„ ì˜¨ë„': 'c_temp_pv_all_is_outlier',
    'RPM': 'k_rpm_pv_all_is_outlier',
    'ìŠ¤í¬ë¥˜ ì†ë„': 'E_scr_pv_all_is_outlier',  // ì •í™•í•œ í‚¤ëª… í™•ì¸
    'ìŠ¤í¬ë¥˜ ì˜¨ë„': 's_temp_pv_all_is_outlier'
  };

  // ê²°ê³¼ ì¹´ìš´íŠ¸ ê°ì²´ ì´ˆê¸°í™”
  const countsBySensor = {};
  for (const name in sensorKeys) {
    countsBySensor[name] = 0;
  }

  const labels = Array.isArray(data.labels_all) ? data.labels_all : [];

  // ì „ì²´ ë ˆì½”ë“œ ìˆœíšŒí•˜ë©°, weekDatesì— ì†í•˜ëŠ” ë‚ ì§œì¸ì§€ í™•ì¸ í›„ í”Œë˜ê·¸ ì¹´ìš´íŠ¸
  for (let i = 0; i < labels.length; i++) {
    // labels_all ìš”ì†Œ í˜•ì‹: "YYYY-MM-DD HH:MM:SS"
    const dateStr = labels[i].split(' ')[0];  // "YYYY-MM-DD"
    if (!weekDates.includes(dateStr)) continue;
    // ì£¼ê°„ ê¸°ê°„ì— ì†í•  ë•Œ
    for (const [sensorName, key] of Object.entries(sensorKeys)) {
      const series = data[key];
      // ë°©ì–´ ì½”ë“œ: seriesê°€ ë°°ì—´ì´ ì•„ë‹ˆê±°ë‚˜ ì¸ë±ìŠ¤ ì´ˆê³¼ ì‹œ ìŠ¤í‚µ
      if (!Array.isArray(series) || i >= series.length) continue;
      const flag = series[i];
      // flagê°€ 1ì´ë©´ ì´ìƒì¹˜ì¸ ê²½ìš° (í•„ìš” ì‹œ 0ì¼ ë•Œ ì´ìƒì¹˜ì¸ ë¡œì§ìœ¼ë¡œ ìˆ˜ì •)
      if (flag === 1) {
        countsBySensor[sensorName]++;
      }
    }
  }

  // í…Œì´ë¸”ì— ë Œë”ë§
  const table = document.getElementById('sensor-status-table-week');
  if (!table) return;
  table.innerHTML = '';

  // í—¤ë” í–‰ ì¶”ê°€ (ì„ íƒ ì‚¬í•­)
  const thead = document.createElement('thead');
  thead.innerHTML = `<tr><th style="text-align: left; padding: 5px 16px; font-size: 18px; color: #ccc; border-bottom: 1px solid #333;">ì„¼ì„œ</th><th style="text-align: right; padding: 5px 16px; font-size: 18px; color: #ccc; border-bottom: 1px solid #333;">ì´ìƒì¹˜ íšŸìˆ˜</th></tr>`;
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  for (const [name, cnt] of Object.entries(countsBySensor)) {
    const row = document.createElement('tr');
    // íšŸìˆ˜ê°€ 0ì´ë©´ ë…¹ìƒ‰, 1íšŒ ì´ìƒì´ë©´ ë¶‰ì€ìƒ‰ ê°•ì¡°
    const color = cnt > 0 ? '#FF5555' : '#00FF88';
    row.innerHTML = `<td style="text-align: left; padding: 10px 16px; font-size: 16px; font-weight: bold; color: #ccc; border-bottom: 1px solid #333;">${name}</td><td style="text-align: right; padding: 10px 16px; font-size: 16px; font-weight:bold; color:${color}; border-bottom: 1px solid #333;">${cnt}íšŒ</td>`;
    tbody.appendChild(row);
  }
  table.appendChild(tbody);
}

// âœ… ì´ˆê¸° ë¡œë”© ì‹œ ë§ˆìŠ¤í„° í•¨ìˆ˜
async function initializeWeeklyDashboard() {
  const picker = document.getElementById('popup-date-picker');
  const selectedDate = new Date().toISOString().split('T')[0];
  if (picker) picker.value = selectedDate;

  weeklyData = await fetchWeeklyData();
  const weekDates = getWeeklyDateStrings(selectedDate);
  const summary = summarizeWeek(weeklyData, weekDates);
  
  renderWeeklySensorStatus(weeklyData, weekDates);
  renderWeeklyProductionText(summary);
  renderWeeklyLossText(summary);
  updateWeeklyPieCharts(summary);
  renderWeeklySalesChart(selectedDate);
  renderWeeklyInterventionChart(weeklyData, weekDates);
  renderWeeklyBarChart('production', selectedDate);
  renderWeeklySensorStatusCounts(weeklyData, weekDates);

  
  document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
  const defaultTab = document.querySelector('.chart-tab[data-type="production"]');
  if (defaultTab) defaultTab.classList.add('active');

  setupWeeklyChartTabs();
}

window.addEventListener('DOMContentLoaded', initializeWeeklyDashboard);
</script>

<!-- ì›” íƒ­ -->
<script>
// âœ… ì „ì—­ ë³€ìˆ˜ ì •ì˜
let monthlyData = null;
let monthlyChartRefs = {}; // Chart.js ì¸ìŠ¤í„´ìŠ¤ ì €ì¥ (bar + pie)

// âœ… ë‹¬ì˜ ëª¨ë“  ì£¼ì°¨ êµ¬í•¨
function getWeeksInMonth(baseDateStr) {
  const date = new Date(baseDateStr);
  const year = date.getFullYear();
  const month = date.getMonth();

  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);

  const weeks = [];
  let currentWeek = [];

  for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
    const day = d.getDay();
    const iso = d.toISOString().split('T')[0];
    currentWeek.push(iso);
    
    if (d.getDay() === 0 || d.getTime() === lastDay.getTime()) {
      weeks.push(currentWeek);
      currentWeek = [];
    }
  }
  return weeks;
}

// âœ… ì£¼ì°¨ ìš”ì•½ ë°ì´í„° ìƒì„±
function summarizeWeeks(data, weekGroups) {
  const { labels_all, values_all, loss_values_all, defect_values_all } = data;
  return weekGroups.map(week => {
    let prod = 0, loss = 0, defect = 0;
    labels_all.forEach((label, i) => {
      const date = label.split(' ')[0];
      if (week.includes(date)) {
        prod += values_all[i] || 0;
        loss += loss_values_all[i] || 0;
        defect += defect_values_all[i] || 0;
      }
    });
    return { prod, loss, defect };
  });
}

// âœ… ì›”ê°„ ìƒì‚° í…ìŠ¤íŠ¸ í‘œì‹œ
function renderMonthlyProductionText(total) {
  const elem = document.getElementById('realtime-month_sum');
  if (elem) elem.textContent = `${total.prod.toFixed(2)} g`;
}

// âœ… ì›”ê°„ ì†ì‹¤ í…ìŠ¤íŠ¸ í‘œì‹œ
function renderMonthlyLossText(total) {
  const elem = document.getElementById('loss-month_cumulative');
  if (elem) elem.textContent = `${total.loss.toFixed(2)} g`;
}

// âœ… íŒŒì´ì°¨íŠ¸ ìƒì„±/ì—…ë°ì´íŠ¸
function createOrUpdatePieChart(id, chartRef, labels, data, colors) {
  const canvas = document.getElementById(id);
  if (!canvas || !canvas.getContext) {
    console.warn(`âš ï¸ Canvas with id=${id} not found.`);
    return;
  }
  const ctx = canvas.getContext('2d');

  const centerTextPlugin = {
    id: 'centerText',
    beforeDraw(chart) {
      const { ctx, width, height, data } = chart;
      const values = data.datasets[0].data.map(v => Number(v) || 0);
      const sum = values.reduce((a, b) => a + b, 0) || 1;
      const pct = ((values[0] / sum) * 100).toFixed(1) + '%';

      ctx.save();
      ctx.font = 'bold 40px sans-serif';
      ctx.fillStyle = '#fff';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText(pct, width / 2, height / 2);
      ctx.restore();
    }
  };

  if (chartRef[id]) {
    chartRef[id].data.labels = labels;
    chartRef[id].data.datasets[0].data = data;
    chartRef[id].data.datasets[0].backgroundColor = colors;
    chartRef[id].update();
  } else {
    chartRef[id] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: colors
        }]
      },
      options: {
        maintainAspectRatio: false,
        cutout: '75%',
        plugins: {
          legend: {
            position: 'top',
            labels: {
              color: '#fff',
              font: { size: 20, weight: 'bold' }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.label || '';
                let value = context.raw || 0;
                return `${label}: ${value}`;
              }
            }
          }
        }
      },
      plugins: [centerTextPlugin]
    });
  }
}

// âœ… ì›”ê°„ íŒŒì´ì°¨íŠ¸ ê°±ì‹ 
function updateMonthlyPieCharts(summaries) {
  const totalProd = summaries.reduce((sum, w) => sum + w.prod, 0);
  const totalLoss = summaries.reduce((sum, w) => sum + w.loss, 0);
  const totalDefect = summaries.reduce((sum, w) => sum + w.defect, 0);
  const totalCount = summaries.length;

  const goal = 10000;
  createOrUpdatePieChart('month_prodPieChart', monthlyChartRefs, ['ìƒì‚°', 'ë¯¸ë‹¬'], [totalProd, Math.max(0, goal - totalProd)], ['#00BFFF', '#333']);
  createOrUpdatePieChart('month_lossPieChart', monthlyChartRefs, ['ì†ì‹¤', 'ì •ìƒ'], [totalLoss, Math.max(0, totalProd - totalLoss)], ['#FFE26B', '#333']);
  createOrUpdatePieChart('month_defectPieChart', monthlyChartRefs, ['ë¶ˆëŸ‰', 'ì •ìƒ'], [totalDefect, totalCount - totalDefect], ['#FF5555', '#333']);
}

// ì›”ê°„ ë§‰ëŒ€ ì°¨íŠ¸
function renderMonthlyBarChart(type, baseDateStr) {
  if (!monthlyData) return;
  const weeks = getWeeksInMonth(baseDateStr);
  const summaries = summarizeWeeks(monthlyData, weeks);

  // ì´í•© ê³„ì‚° ì¶”ê°€
  const total = summaries.reduce((acc, cur) => {
    acc.prod += cur.prod;
    acc.loss += cur.loss;
    return acc;
  }, { prod: 0, loss: 0 });

  renderMonthlyProductionText(total);
  renderMonthlyLossText(total);

  const data = summaries.map(s =>
    type === 'month_production' ? s.prod :
    type === 'month_loss' ? s.loss :
    s.defect
  );

  const sum = data.reduce((a, b) => a + b, 0).toFixed(2);
  const unit = type === 'month_defect' ? 'ê±´' : 'g';
  // ğŸ³ id ì¤‘ë³µìœ¼ë¡œ percentage-display => montly-percentage-display ìˆ˜ì •
  document.getElementById('monthly-percentage-display').textContent = `ì´í•©: ${sum} ${unit}`;

  const ctx = document.getElementById('monthly-chart')?.getContext('2d');
  if (!ctx) return;

  const labels = weeks.map((_, i) => `${i + 1}ì£¼ì°¨`);

  if (monthlyChartRefs.bar) {
    monthlyChartRefs.bar.data.labels = labels;
    monthlyChartRefs.bar.data.datasets[0].data = data;
    monthlyChartRefs.bar.update();
  } else {
    monthlyChartRefs.bar = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{ label: 'ì›”ê°„ í†µê³„', data, backgroundColor: '#00cc88' }]
      },
      options: {
        layout: {
          padding: {
            top:    0,
            bottom: 0,
            left:   15,
            right:  0
          }
        },
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false },
        datalabels: {anchor: 'end', align:  'top', formatter: v => v.toLocaleString(), color: '#fff', font: { weight: 'bold', size: 16 }}
      
      
      
        },
        scales: {
          y: {
            grid: { color: '#333' },
            beginAtZero: true,
            ticks: {
              color: '#ccc',
              font: {size:18, weight: 'bold'},
              callback: val => (type === 'month_defect' ? val : val + 'g')
            }
          },
          x: { grid: { color: '#333' }, ticks: { color: '#ccc', font: {size:18, weight: 'bold'} } }
        }
      },
      plugins: [ ChartDataLabels ]
    });
  }

  // íŒŒì´ì°¨íŠ¸ë„ ê°±ì‹ 
  updateMonthlyPieCharts(summaries);
  renderMonthlySalesChart(baseDateStr);
  renderMonthlySensorStatus(monthlyData, baseDateStr);
}


function renderMonthlySensorStatus(data, baseDateStr) {
  const keys = {
    'ì‚¬ì¶œ ì˜¨ë„': 'n_temp_pv_all_is_outlier',
    'ì±”ë²„ ì˜¨ë„': 'c_temp_pv_all_is_outlier',
    'RPM': 'k_rpm_pv_all_is_outlier',
    'ìŠ¤í¬ë¥˜ ì†ë„': 'E_scr_pv_all_is_outlier',
    'ìŠ¤í¬ë¥˜ ì˜¨ë„': 's_temp_pv_all_is_outlier'
  };

  // ê¸°ì¤€ ë‚ ì§œë¡œ í•´ë‹¹ ì›”ì˜ ëª¨ë“  ë‚ ì§œ êµ¬í•˜ê¸°
  const baseDate = new Date(baseDateStr);
  const year = baseDate.getFullYear();
  const month = baseDate.getMonth();
  const start = new Date(year, month, 1);
  const end = new Date(year, month + 1, 0);

  const monthDates = [];
  for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
    monthDates.push(d.toISOString().split('T')[0]);
  }

  const counts = {};
  Object.entries(keys).forEach(([label, key]) => {
    const series = data[key];
    let count = 0;
    data.labels_all.forEach((time, i) => {
      const dateStr = time.split(' ')[0];
      if (monthDates.includes(dateStr) && series[i] === 1) {
        count++;
      }
    });
    counts[label] = count;
  });

  const table = document.getElementById('sensor-status-table-month');
  if (!table) return;
  table.innerHTML = '';
  Object.entries(counts).forEach(([name, cnt]) => {
    const row = document.createElement('tr');
    row.innerHTML = `<td style="text-align: left; padding: 10px 16px; font-size: 16px; font-weight: bold; color: #ccc; border-bottom: 1px solid #333;">${name}</td><td style="text-align: right; padding: 10px 16px; font-size: 16px; font-weight:bold; color:${cnt > 0 ? '#FF5555' : '#00FF88'}; border-bottom: 1px solid #333;">${cnt} íšŒ</td>`;
    table.appendChild(row);
  });
}

function renderMonthlyInterventionChart(baseDateStr) {
  if (!monthlyData || !monthlyData.scale_pv_all || !monthlyData.labels_all) return;

  const weekGroups = getWeeksInMonth(baseDateStr);
  const labels = monthlyData.labels_all;
  const values = monthlyData.scale_pv_all;

  const countsPerWeek = weekGroups.map(week => {
    const weekSeries = [];

    labels.forEach((label, i) => {
      const dateStr = label.split(' ')[0];
      if (week.includes(dateStr)) {
        weekSeries.push(values[i]);
      }
    });

    let count = 0;
    let streak = 0;

    for (let i = 0; i < weekSeries.length; i++) {
      const v = weekSeries[i];
      if (v < 2.9 || v > 3.3) {
        streak++;
        if (streak === 20) {
          count++;
          streak = 0;
        }
      } else {
        streak = 0;
      }
    }

    return count;
  });

  const ctx = document.getElementById('monthly_intervention-bar')?.getContext('2d');
  if (!ctx) return;

  const labelsKor = weekGroups.map((_, i) => `${i + 1}ì£¼ì°¨`);

  if (monthlyChartRefs.intervention) {
    monthlyChartRefs.intervention.data.labels = labelsKor;
    monthlyChartRefs.intervention.data.datasets[0].data = countsPerWeek;
    monthlyChartRefs.intervention.update();
  } else {
    monthlyChartRefs.intervention = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labelsKor,
        datasets: [{
          label: 'ê°œì… ê±´ìˆ˜',
          data: countsPerWeek,
          backgroundColor: '#ff6688'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: {
            top: 20,  // âœ… ìˆ«ì ëŠ˜ë ¤ì„œ ì—¬ë°± í™•ë³´
          
          }
        },
        plugins: {
          legend: { display: false },
          datalabels: {
          anchor: 'end',            
          align:  'end',             
          formatter: v => v.toLocaleString(), // ì²œë‹¨ìœ„ ì½¤ë§ˆ
          color:     '#fff',         // í°ìƒ‰ í°íŠ¸
          font:      { size: 16, weight: 'bold' }
        },

        tooltip: {
          callbacks: {
            label: ctx => `${ctx.parsed.y} íšŒ`
            }
          }
        },
        scales: {
          y: {
            grid: { color: '#333' },
            beginAtZero: true,
            ticks: {
              color: '#ccc',
              font: {size: 18,
              weight: 'bold'}, 
              callback: val => `${val} íšŒ`
            }
          },
          x: { grid: { color: '#333' }, ticks: { color: '#ccc', font: {size: 18, weight: 'bold'} } }
        }
      },
      plugins: [ ChartDataLabels ]
    });
  }
}


function renderMonthlySalesChart(baseDateStr) {
  if (!monthlyData) return;

  const weekGroups = getWeeksInMonth(baseDateStr); // ì£¼ì°¨ë³„ ë‚ ì§œ ë°°ì—´
  const labels = monthlyData.labels_all;
  const values = monthlyData.values_all;

  const salesPerWeek = weekGroups.map(weekDates => {
    let totalGram = 0;
    labels.forEach((label, i) => {
      const date = label.split(' ')[0];
      if (weekDates.includes(date)) {
        totalGram += values[i] || 0;
      }
    });
    return +(totalGram * 5).toFixed(2); // ë‹¨ê°€ â‚©5
  });

  const totalSales = salesPerWeek.reduce((a, b) => a + b, 0).toLocaleString();
  const ctx = document.getElementById('monthly-sales-bar')?.getContext('2d');
  if (!ctx) return;

  const labelsKor = weekGroups.map((_, i) => `${i + 1}ì£¼ì°¨`);
  const display = document.getElementById('monthly-sales-total');
  if (display) display.textContent = `(ì´ ë§¤ì¶œ: â‚©${totalSales})`;

if (monthlyChartRefs.sales) {
  monthlyChartRefs.sales.data.labels = labelsKor;
  monthlyChartRefs.sales.data.datasets[0].data = salesPerWeek;
  monthlyChartRefs.sales.update();
} else {
  monthlyChartRefs.sales = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labelsKor,
      datasets: [{ label: 'ì£¼ì°¨ë³„ ë§¤ì¶œ (â‚©)', data: salesPerWeek, backgroundColor: '#00FF88', barPercentage: 0.4, categoryPercentage: 0.7 }]
    },
      options: {
        layout: {
          padding: { top: 10, bottom: 0, left: 30, right: 10 }
        },
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          datalabels: {
            anchor: 'end',        
            align:  'top',             
            formatter: v => v.toLocaleString(), 
            color:     '#fff',         
            font:      { weight: 'bold', size: 16 }},
          tooltip: {
            callbacks: {
              label: ctx => `â‚©${ctx.parsed.y.toLocaleString()}`
            }
          }
        },
        scales: {
          y: {
            grid: { color: '#333'},
            beginAtZero: true,
            ticks: {
              color: '#ccc',
              font: { size: 18, weight: 'bold'},
              callback: val => 'â‚©' + Number(val).toLocaleString()
            }
          },
          x: { grid: { color: '#333'}, ticks: { color: '#ccc', font: {size:18, weight: 'bold'} } }
        }
      },
      plugins: [ ChartDataLabels ]
    });
  }
}

// íƒ­ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
function setupMonthlyChartTabs() {
  document.querySelectorAll('.month_chart-tab-btn').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.month_chart-tab-btn').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const type = tab.dataset.type;
      const selectedDate = document.getElementById('popup-date-picker').value;
      renderMonthlyBarChart(type, selectedDate);
    });
  });
}

// âœ… ì´ˆê¸° ì‹¤í–‰ í•¨ìˆ˜
async function initializeMonthlyDashboard() {
  const picker = document.getElementById('popup-date-picker');
  const selectedDate = new Date().toISOString().split('T')[0];
  if (picker) picker.value = selectedDate;

  const res = await fetch('/api/production_all');
  monthlyData = await res.json();

  renderMonthlyBarChart('month_production', selectedDate);
  setupMonthlyChartTabs();
  renderMonthlyInterventionChart(selectedDate);

  // ê¸°ë³¸ íƒ­ í™œì„±í™”
  document.querySelectorAll('.month_chart-tab-btn').forEach(t => t.classList.remove('active'));
  const defaultTab = document.querySelector('.month_chart-tab-btn[data-type="month_production"]');
  if (defaultTab) defaultTab.classList.add('active');
}

window.addEventListener('DOMContentLoaded', initializeMonthlyDashboard);
</script>
{% endblock %}